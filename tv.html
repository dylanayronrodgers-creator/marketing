<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Axxess - Customer Recognition Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--tv-bg, linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%));
      min-height: 100vh;
      color: white;
      overflow: hidden;
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tv-shell {
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      height: 100vh;
      padding: 24px;
      gap: 20px;
    }

    /* Header */
    .tv-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .tv-header .brand { display: flex; align-items: center; gap: 20px; }
    .tv-header .logo { height: 48px; width: auto; }
    .tv-header .title { font-size: 28px; font-weight: 700; }
    .tv-header .subtitle { font-size: 13px; color: #94a3b8; margin-top: 2px; }
    .tv-header .right { display: flex; align-items: center; gap: 16px; }
    .live-badge {
      display: flex; align-items: center; gap: 8px;
      background: rgba(16, 185, 129, 0.15);
      padding: 8px 16px; border-radius: 999px;
    }
    .live-dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse-slow 1.5s ease-in-out infinite; }
    .live-badge span { color: #10b981; font-size: 13px; font-weight: 600; }
    .clock { font-size: 20px; font-weight: 600; color: #cbd5e1; }

    @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Stat Cards Row */
    .stat-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
    }
    .stat-card {
      border-radius: 16px; padding: 20px;
      transition: all 0.3s ease;
    }
    .stat-card:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); }
    .stat-icon {
      width: 44px; height: 44px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 14px; font-size: 20px;
    }
    .stat-value { font-size: 36px; font-weight: 800; margin-bottom: 4px; }
    .stat-label { font-size: 13px; color: #94a3b8; }

    .glow-blue { box-shadow: 0 0 30px rgba(59, 130, 246, 0.2); }
    .glow-green { box-shadow: 0 0 30px rgba(16, 185, 129, 0.2); }
    .glow-purple { box-shadow: 0 0 30px rgba(139, 92, 246, 0.2); }
    .glow-amber { box-shadow: 0 0 30px rgba(245, 158, 11, 0.2); }
    .glow-pink { box-shadow: 0 0 30px rgba(236, 72, 153, 0.2); }

    /* Main Content */
    .tv-main {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 20px;
      min-height: 0;
      overflow: hidden;
    }
    .tv-left {
      display: flex; flex-direction: column; gap: 16px;
      min-height: 0; overflow: hidden;
    }

    /* Cards */
    .tv-card {
      border-radius: 16px; overflow: hidden;
      display: flex; flex-direction: column;
    }
    .tv-card.grow { flex: 1; min-height: 0; }
    .tv-left .tv-card.grow { flex: 1.2; }
    .tv-left .tv-card:not(.grow) { flex: 0 0 auto; }

    .tv-card-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex; justify-content: space-between; align-items: center;
    }
    .tv-card-title { font-size: 18px; font-weight: 700; }
    .tv-card-hint { font-size: 12px; color: #64748b; margin-top: 2px; }
    .tv-card-badge { font-size: 13px; color: #3b82f6; font-weight: 600; }
    .tv-card-body { padding: 16px 20px; flex: 1; overflow: auto; min-height: 0; }

    /* Rank List */
    .tv-rank-list { display: flex; flex-direction: column; gap: 8px; }
    .tv-rank-row {
      display: grid; grid-template-columns: 44px 1fr auto;
      gap: 14px; align-items: center;
      padding: 12px 14px; border-radius: 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      transition: all 0.2s;
    }
    .tv-rank-row:hover { background: rgba(255,255,255,0.06); }

    .tv-rank-row.rank-1 {
      background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(245,158,11,0.1));
      border-color: rgba(251,191,36,0.3);
      box-shadow: 0 0 20px rgba(251,191,36,0.1);
    }
    .tv-rank-row.rank-2 {
      background: linear-gradient(135deg, rgba(148,163,184,0.12), rgba(100,116,139,0.08));
      border-color: rgba(148,163,184,0.25);
    }
    .tv-rank-row.rank-3 {
      background: linear-gradient(135deg, rgba(249,115,22,0.12), rgba(234,88,12,0.08));
      border-color: rgba(249,115,22,0.25);
    }

    .tv-rank-num {
      width: 44px; height: 44px; border-radius: 12px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white; font-size: 18px; font-weight: 800;
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    .rank-1 .tv-rank-num { background: linear-gradient(135deg, #fbbf24, #f59e0b); box-shadow: 0 0 15px rgba(251,191,36,0.4); }
    .rank-2 .tv-rank-num { background: linear-gradient(135deg, #94a3b8, #64748b); }
    .rank-3 .tv-rank-num { background: linear-gradient(135deg, #f97316, #ea580c); }

    .tv-rank-num.gold::after { content: "üèÜ"; position: absolute; top: -10px; right: -6px; font-size: 16px; }
    .tv-rank-num.silver::after { content: "ü•à"; position: absolute; top: -8px; right: -5px; font-size: 14px; }
    .tv-rank-num.bronze::after { content: "ü•â"; position: absolute; top: -8px; right: -5px; font-size: 14px; }

    .tv-rank-name { font-size: 15px; font-weight: 700; color: #f1f5f9; }
    .tv-rank-meta { font-size: 11px; color: #64748b; margin-top: 2px; }
    .tv-rank-score { font-size: 20px; font-weight: 800; color: #3b82f6; text-align: right; }
    .rank-1 .tv-rank-score { color: #fbbf24; }
    .rank-2 .tv-rank-score { color: #94a3b8; }
    .rank-3 .tv-rank-score { color: #f97316; }
    .tv-rank-reason { font-size: 11px; color: #64748b; text-align: right; max-width: 140px; }

    /* Highlight Slide */
    .tv-highlight {
      height: 100%; display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      padding: 32px; text-align: center;
      transition: opacity 0.4s ease;
    }
    .tv-celebration-badge {
      background: rgba(59,130,246,0.15); color: #60a5fa;
      padding: 6px 16px; border-radius: 999px;
      font-size: 11px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px;
      margin-bottom: 16px; border: 1px solid rgba(59,130,246,0.2);
    }
    .tv-quote {
      font-size: 28px; font-weight: 600; color: #f1f5f9;
      line-height: 1.4; max-width: 90%; margin-bottom: 20px;
    }
    .tv-keywords { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 24px; }
    .tv-keyword {
      padding: 6px 14px; border-radius: 999px;
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
      color: #94a3b8; font-size: 12px; font-weight: 500;
    }
    .tv-agent-card {
      display: flex; align-items: center; gap: 16px;
      background: rgba(255,255,255,0.05); padding: 16px 24px;
      border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
      width: 100%; max-width: 500px;
    }
    .tv-agent-avatar {
      width: 50px; height: 50px; border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white; display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: 700; flex-shrink: 0;
    }
    .tv-agent-info { text-align: left; flex: 1; }
    .tv-agent-name { font-size: 15px; font-weight: 600; color: #f1f5f9; }
    .tv-agent-team { font-size: 12px; color: #64748b; margin-top: 2px; }
    .tv-agent-source {
      padding: 6px 14px; border-radius: 8px;
      background: rgba(59,130,246,0.15); color: #60a5fa;
      font-weight: 600; font-size: 12px;
    }

    /* Monthly Podium */
    .tv-podium { display: flex; flex-direction: column; gap: 10px; }
    .tv-podium-card {
      padding: 14px; border-radius: 12px; position: relative; overflow: hidden;
      background: linear-gradient(135deg, rgba(251,191,36,0.1), rgba(245,158,11,0.05));
      border: 1px solid rgba(251,191,36,0.2);
    }
    .tv-podium-card:nth-child(2) {
      background: linear-gradient(135deg, rgba(148,163,184,0.08), rgba(100,116,139,0.04));
      border-color: rgba(148,163,184,0.2);
    }
    .tv-podium-top { display: flex; align-items: center; justify-content: space-between; }
    .tv-podium-info { display: flex; align-items: center; gap: 12px; }
    .tv-avatar {
      width: 44px; height: 44px; border-radius: 12px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white; display: flex; align-items: center; justify-content: center;
      font-size: 16px; font-weight: 800;
    }
    .tv-podium-name { font-size: 16px; font-weight: 700; color: #f1f5f9; }
    .tv-podium-meta { font-size: 12px; color: #64748b; margin-top: 2px; }
    .tv-themes { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
    .tv-theme {
      padding: 4px 10px; border-radius: 999px;
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);
      color: #94a3b8; font-size: 11px;
    }

    /* Footer Ticker */
    .tv-footer {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 12px 20px; border-radius: 12px;
      overflow: hidden;
    }
    .tv-ticker {
      white-space: nowrap;
      animation: tickerScroll 40s linear infinite;
      color: #94a3b8; font-weight: 500; font-size: 13px;
    }
    @keyframes tickerScroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }

    /* Scrollbar */
    .tv-card-body::-webkit-scrollbar { width: 4px; }
    .tv-card-body::-webkit-scrollbar-track { background: transparent; }
    .tv-card-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 2px; }

    /* Responsive */
    @media (max-width: 1440px) {
      .tv-shell { padding: 16px; gap: 14px; }
      .stat-value { font-size: 28px; }
      .tv-quote { font-size: 22px; }
      .tv-rank-row { padding: 10px 12px; }
      .tv-rank-num { width: 36px; height: 36px; font-size: 14px; }
      .tv-rank-name { font-size: 13px; }
      .tv-rank-score { font-size: 16px; }
    }
    @media (max-width: 1024px) {
      .tv-main { grid-template-columns: 1fr; }
      .stat-row { grid-template-columns: repeat(3, 1fr); }
      .tv-quote { font-size: 20px; }
    }
    @media (min-width: 1920px) {
      .tv-shell { padding: 32px; gap: 24px; }
      .stat-value { font-size: 44px; }
      .tv-header .title { font-size: 34px; }
      .tv-quote { font-size: 34px; }
      .tv-rank-name { font-size: 18px; }
      .tv-rank-score { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="tv-shell">
    <!-- Header -->
    <header class="tv-header">
      <div class="brand">
        <img class="logo" src="https://i.ibb.co/fGy3TCJd/logo-axxess-1.png" alt="Axxess" />
        <div style="border-left: 1px solid #334155; padding-left: 16px; margin-left: 4px;">
          <div class="title">Customer Recognition</div>
          <div class="subtitle" id="tvWeek">Week</div>
        </div>
      </div>
      <div class="right">
        <div class="live-badge"><div class="live-dot"></div><span>LIVE</span></div>
        <div class="clock" id="clock"></div>
      </div>
    </header>

    <!-- Stats Row -->
    <div class="stat-row">
      <div class="stat-card glass glow-blue">
        <div class="stat-icon" style="background:rgba(59,130,246,0.15); color:#60a5fa;">‚òÖ</div>
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-label">Total Reviews</div>
      </div>
      <div class="stat-card glass glow-green">
        <div class="stat-icon" style="background:rgba(16,185,129,0.15); color:#34d399;">‚úì</div>
        <div class="stat-value" id="statApproved">0</div>
        <div class="stat-label">Approved</div>
      </div>
      <div class="stat-card glass glow-purple">
        <div class="stat-icon" style="background:rgba(139,92,246,0.15); color:#a78bfa;">‚ó∑</div>
        <div class="stat-value" id="statPending">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card glass glow-amber">
        <div class="stat-icon" style="background:rgba(245,158,11,0.15); color:#fbbf24;">%</div>
        <div class="stat-value" id="statSentiment">0%</div>
        <div class="stat-label">Positive Sentiment</div>
      </div>
      <div class="stat-card glass glow-pink">
        <div class="stat-icon" style="background:rgba(236,72,153,0.15); color:#f472b6;">‚öë</div>
        <div class="stat-value" id="statNegative">0</div>
        <div class="stat-label">Negative Flagged</div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="tv-main">
      <div class="tv-left">
        <div class="tv-card glass grow">
          <div class="tv-card-header">
            <div>
              <div class="tv-card-title">Weekly Top 5</div>
              <div class="tv-card-hint">Agent recognition leaders</div>
            </div>
            <div class="tv-card-badge" id="tvWeekSmall"></div>
          </div>
          <div class="tv-card-body">
            <div class="tv-rank-list" id="weeklyList"></div>
          </div>
        </div>

        <div class="tv-card glass">
          <div class="tv-card-header">
            <div>
              <div class="tv-card-title">Monthly Leaders</div>
              <div class="tv-card-hint" id="tvMonth">Month</div>
            </div>
            <div class="tv-card-badge">Top 2</div>
          </div>
          <div class="tv-card-body">
            <div class="tv-podium" id="monthlyPodium"></div>
          </div>
        </div>
      </div>

      <div class="tv-card glass grow">
        <div class="tv-card-header">
          <div>
            <div class="tv-card-title">Live Highlights</div>
            <div class="tv-card-hint">Customer feedback</div>
          </div>
          <div class="tv-card-badge" id="slideCounter"></div>
        </div>
        <div class="tv-card-body">
          <div class="tv-highlight" id="highlightSlide"></div>
        </div>
      </div>
    </main>

    <!-- Footer Ticker -->
    <footer class="tv-footer">
      <div class="tv-ticker" id="ticker"></div>
    </footer>
  </div>

  <script src="./app.js"></script>
  <script>
(function() {
  // --- LOAD TV CONFIG ---
  var TV_CONFIG_KEY = "axxess_tv_config";
  var tvCfg;
  try { tvCfg = JSON.parse(localStorage.getItem(TV_CONFIG_KEY)) || {}; } catch(e) { tvCfg = {}; }

  // Background themes
  var bgMap = {
    dark: "linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%)",
    midnight: "linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%)",
    charcoal: "linear-gradient(135deg, #18181b 0%, #27272a 50%, #18181b 100%)",
    ocean: "linear-gradient(135deg, #0c1222 0%, #162032 50%, #0c1222 100%)",
    forest: "linear-gradient(135deg, #052e16 0%, #14532d 50%, #052e16 100%)",
    wine: "linear-gradient(135deg, #1c0a1a 0%, #2d1228 50%, #1c0a1a 100%)"
  };

  // Apply background
  if (tvCfg.bgTheme && bgMap[tvCfg.bgTheme]) {
    document.body.style.background = bgMap[tvCfg.bgTheme];
  }

  // Apply logo
  var logoEl = document.querySelector(".tv-header .logo");
  if (tvCfg.logoUrl && logoEl) logoEl.src = tvCfg.logoUrl;

  // Apply title
  var titleEl = document.querySelector(".tv-header .title");
  if (tvCfg.tvTitle && titleEl) titleEl.textContent = tvCfg.tvTitle;

  // Apply brand color to accent elements
  if (tvCfg.brandColor) {
    document.documentElement.style.setProperty("--tv-brand", tvCfg.brandColor);
  }

  // Apply page title
  if (tvCfg.companyName) document.title = tvCfg.companyName + " - " + (tvCfg.tvTitle || "Customer Recognition Dashboard");

  // Visibility toggles
  var statRow = document.querySelector(".stat-row");
  if (statRow && tvCfg.showStats === false) statRow.style.display = "none";

  var footerEl = document.querySelector(".tv-footer");
  if (footerEl && tvCfg.showTicker === false) footerEl.style.display = "none";

  var clockContainer = document.querySelector(".tv-header .clock");
  if (clockContainer && tvCfg.showClock === false) clockContainer.style.display = "none";

  // Layout adjustments
  var tvMain = document.querySelector(".tv-main");
  var tvLeft = document.querySelector(".tv-left");
  var highlightCard = tvMain ? tvMain.querySelector(":scope > .tv-card.glass.grow") : null;

  if (tvCfg.layout === "highlights-only" && tvMain && tvLeft) {
    tvLeft.style.display = "none";
    tvMain.style.gridTemplateColumns = "1fr";
  } else if (tvCfg.layout === "leaderboard-only" && tvMain && highlightCard) {
    highlightCard.style.display = "none";
    tvMain.style.gridTemplateColumns = "1fr";
  }

  // Weekly/Monthly visibility within left panel
  if (tvLeft) {
    var weeklyCard = tvLeft.querySelector(".tv-card.glass.grow");
    var monthlyCard = tvLeft.querySelector(".tv-card.glass:not(.grow)");
    if (weeklyCard && tvCfg.showWeekly === false) weeklyCard.style.display = "none";
    if (monthlyCard && tvCfg.showMonthly === false) monthlyCard.style.display = "none";
  }

  if (highlightCard && tvCfg.showHighlights === false) highlightCard.style.display = "none";

  var state = loadState();
  var elWeek = document.getElementById("tvWeek");
  var elWeekSmall = document.getElementById("tvWeekSmall");
  var elMonth = document.getElementById("tvMonth");
  var weeklyList = document.getElementById("weeklyList");
  var podium = document.getElementById("monthlyPodium");
  var ticker = document.getElementById("ticker");
  var slide = document.getElementById("highlightSlide");
  var counter = document.getElementById("slideCounter");
  var clockEl = document.getElementById("clock");
  var highlightIdx = 0;
  var highlights = [];
  var SLIDE_INTERVAL = (tvCfg.slideInterval || 8) * 1000;
  var lastStateHash = "";

  // Clock
  function updateClock() {
    var now = new Date();
    clockEl.textContent = now.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
  }
  updateClock();
  setInterval(updateClock, 1000);

  function formatWeekRange(startIso) {
    var d = new Date(startIso);
    var end = new Date(d); end.setDate(end.getDate() + 6);
    var fmt = function(x) { return x.toLocaleDateString(undefined, { day: "2-digit", month: "short" }); };
    return "Week of " + fmt(d) + " ‚Äì " + fmt(end);
  }
  function formatMonthLabel(now) {
    return (now || new Date()).toLocaleDateString(undefined, { month: "long", year: "numeric" });
  }
  function initials(name) {
    return String(name || "").split(" ").filter(Boolean).slice(0, 2).map(function(p) { return p[0]; }).join("").toUpperCase();
  }
  function stars(rating) {
    if (rating == null) return "";
    var full = Math.floor(rating); var html = "";
    for (var i = 0; i < 5; i++) html += '<span style="color:' + (i < full ? '#fbbf24' : '#374151') + '; font-size:20px;">‚òÖ</span>';
    return html;
  }
  function timeAgo(dateStr) {
    var diff = Math.floor((new Date() - new Date(dateStr)) / 1000);
    if (diff < 60) return "just now";
    if (diff < 3600) return Math.floor(diff / 60) + "m ago";
    if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
    if (diff < 604800) return Math.floor(diff / 86400) + "d ago";
    return new Date(dateStr).toLocaleDateString(undefined, { day: "2-digit", month: "short" });
  }

  function render() {
    state = loadState();
    var now = new Date();
    var lb = computeLeaderboards(state, now);
    var stats = computeStats(state);

    // Stats
    document.getElementById("statTotal").textContent = state.items.length;
    document.getElementById("statApproved").textContent = state.items.filter(function(i) { return i.status === "Approved"; }).length;
    document.getElementById("statPending").textContent = stats.pending;
    document.getElementById("statSentiment").textContent = stats.avgSentiment;
    document.getElementById("statNegative").textContent = stats.negativeFlagged;

    elWeek.textContent = formatWeekRange(lb.weekStart);
    elWeekSmall.textContent = formatWeekRange(lb.weekStart);
    elMonth.textContent = formatMonthLabel(now);

    // Check if data changed
    var hash = state.items.length + "-" + state.items.filter(function(i) { return i.status === "Approved"; }).length;
    if (hash !== lastStateHash) {
      lastStateHash = hash;

      // Weekly Top 5
      weeklyList.innerHTML = lb.weeklyTop.slice(0, 5).map(function(r, i) {
        var rankClass = i < 3 ? ' rank-' + (i + 1) : '';
        var medalClass = i === 0 ? ' gold' : i === 1 ? ' silver' : i === 2 ? ' bronze' : '';
        return '<div class="tv-rank-row' + rankClass + '">' +
          '<div class="tv-rank-num' + medalClass + '">' + (i + 1) + '</div>' +
          '<div><div class="tv-rank-name">' + r.agent + '</div>' +
          '<div class="tv-rank-meta">' + r.team + ' ¬∑ ' + r.count + ' reviews</div></div>' +
          '<div><div class="tv-rank-score">' + Math.round(r.score) + '</div>' +
          '<div class="tv-rank-reason">' + ((r.themes || []).join(" ¬∑ ") || "Great feedback") + '</div></div></div>';
      }).join("") || '<div style="text-align:center; padding:40px; color:#475569;">No weekly leaders yet</div>';

      // Monthly
      podium.innerHTML = lb.monthlyTop.map(function(m, i) {
        return '<div class="tv-podium-card">' +
          '<div class="tv-podium-top"><div class="tv-podium-info"><div class="tv-avatar">' + initials(m.agent) + '</div>' +
          '<div><div class="tv-podium-name">#' + (i+1) + ' ' + m.agent + '</div>' +
          '<div class="tv-podium-meta">' + m.team + ' ¬∑ Score ' + Math.round(m.score) + '</div></div></div>' +
          '<div class="tv-rank-num" style="width:40px;height:40px;font-size:14px;">' + (i+1) + '</div></div>' +
          '<div class="tv-themes">' + (m.themes || []).map(function(t) { return '<span class="tv-theme">' + t + '</span>'; }).join("") + '</div></div>';
      }).join("") || '<div style="text-align:center; padding:20px; color:#475569;">No monthly leaders yet</div>';

      highlights = lb.highlights;
      if (highlightIdx >= highlights.length) highlightIdx = 0;
    }

    // Ticker
    var approvedCount = state.items.filter(function(i) { return i.status === "Approved" && i.sentiment !== "Negative"; }).length;
    var googleCount = state.items.filter(function(i) { return i.source === "Google"; }).length;
    var topTheme = lb.weeklyTop[0] && lb.weeklyTop[0].themes && lb.weeklyTop[0].themes[0] ? lb.weeklyTop[0].themes[0] : "Customer excellence";
    var tickerItems = [
      "Approved: " + approvedCount,
      "Pending: " + stats.pending,
      "Top theme: " + topTheme,
      "Google reviews: " + googleCount,
      "Total: " + state.items.length,
      stats.avgSentiment
    ];
    if (tvCfg.tickerMsg) tickerItems.push(tvCfg.tickerMsg);
    var loop = tickerItems.concat(tickerItems).concat(tickerItems);
    ticker.textContent = loop.map(function(t) { return "     ¬∑     " + t; }).join("");
  }

  function renderSlide() {
    slide.style.opacity = "0";
    setTimeout(function() {
      if (!highlights.length) {
        slide.innerHTML = '<div style="text-align:center;">' +
          '<div style="font-size:40px; margin-bottom:12px; opacity:0.5;">üìã</div>' +
          '<div class="tv-quote" style="font-size:22px; color:#64748b;">No approved highlights yet</div>' +
          '<div style="color:#475569; font-size:13px; margin-top:8px;">Approve items in the Manager Portal</div></div>';
        counter.textContent = "0/0";
        slide.style.opacity = "1";
        return;
      }
      var s = highlights[highlightIdx % highlights.length];
      var quote = s.tvSnippet || s.text;
      if (quote.length > 180) quote = quote.substring(0, 180) + "...";

      var avatarHtml;
      if (s.reviewerThumbnail) {
        avatarHtml = '<img src="' + s.reviewerThumbnail + '" style="width:50px;height:50px;border-radius:50%;object-fit:cover;flex-shrink:0;" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';" />' +
          '<div class="tv-agent-avatar" style="display:none;">' + initials(s.reviewerName || s.agent) + '</div>';
      } else {
        avatarHtml = '<div class="tv-agent-avatar">' + initials(s.agent) + '</div>';
      }

      var reviewerName = s.reviewerName || s.agent || "Customer";
      slide.innerHTML = '<div class="tv-celebration-badge">' + (s.source === "Google" ? "Google Review" : "Customer Feedback") + '</div>' +
        (s.rating ? '<div style="margin-bottom:10px;">' + stars(s.rating) + '</div>' : '') +
        '<div class="tv-quote">"' + quote + '"</div>' +
        '<div class="tv-keywords">' + (s.keywords || []).slice(0, 5).map(function(k) { return '<span class="tv-keyword">' + k + '</span>'; }).join("") + '</div>' +
        '<div class="tv-agent-card">' + avatarHtml +
        '<div class="tv-agent-info"><div class="tv-agent-name">' + reviewerName + '</div>' +
        '<div class="tv-agent-team">' + (s.agent !== "Unknown" ? s.agent + ' ¬∑ ' : '') + s.team + (s.theme ? ' ¬∑ ' + s.theme : '') + '</div></div>' +
        '<div style="text-align:right;flex-shrink:0;"><div class="tv-agent-source">' + s.source + '</div>' +
        '<div style="font-size:11px;color:#475569;margin-top:4px;">' + timeAgo(s.createdAt) + '</div></div></div>';

      counter.textContent = ((highlightIdx % highlights.length) + 1) + "/" + highlights.length;
      highlightIdx += 1;
      slide.style.opacity = "1";
    }, 350);
  }

  slide.style.transition = "opacity 0.35s ease";
  render();
  renderSlide();
  setInterval(renderSlide, SLIDE_INTERVAL);
  setInterval(render, 15000);

  console.log("TV Dashboard ready. Items:", state.items.length);
})();
  </script>
</body>
</html>
