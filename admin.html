<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Axxess - Manager Portal</title>
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="adminShell">
    <aside class="sidebar">
      <div class="brand">
        <img class="logo" src="https://i.ibb.co/1GrhnMc4/images.jpg" alt="Axxess" />
        <div class="titleBlock">
          <div class="title">Manager Portal</div>
          <div class="subtitle">Approvals + performance insights</div>
        </div>
      </div>

      <div class="navGroup" id="nav">
        <a class="navItem active" href="#overview" data-view="overview">Overview</a>
        <a class="navItem" href="#queue" data-view="queue">Approvals Queue</a>
        <a class="navItem" href="#approved" data-view="approved">Approved Reviews</a>
        <a class="navItem" href="#agents" data-view="agents">Agents &amp; Teams</a>
        <a class="navItem" href="#negative" data-view="negative">Negative (Internal)</a>
        <a class="navItem" href="#import" data-view="import">Agents Import / Config</a>
        <a class="navItem" href="#settings" data-view="settings">Settings</a>
      </div>
    </aside>

    <main class="main">
      <div class="topbar" style="margin-bottom:14px;">
        <div>
          <div class="title" id="viewTitle">Overview</div>
          <div class="subtitle" id="viewSubtitle">High level health and pipeline</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="resetBtn">Reset demo data</button>
          <a class="btn primary" href="./tv.html" target="_blank">Open TV</a>
          <a class="btn" href="#settings" data-view="settings">Settings</a>
        </div>
      </div>

      <section id="view-overview">
        <div id="helpBanner" style="display:none; margin-bottom:14px; padding:14px 18px; border-radius:12px; border:2px solid rgba(0,153,204,.4); background:rgba(0,153,204,.08); color:var(--text);">
          <div style="font-weight:900; margin-bottom:6px;">Welcome to the Manager Portal</div>
          <div style="font-size:13px; line-height:1.4; color:var(--muted);">
            Click <strong style="color:var(--brand-dark);">Reset demo data</strong> (top right) to load sample feedback items. Then approve items in the Queue to see them appear on the TV Dashboard.
          </div>
        </div>

        <div class="kpis" id="kpis"></div>

        <div class="sectionTitle">Insights</div>
        <div class="split">
          <div class="preview">
            <div class="previewLabel">Top themes</div>
            <div class="previewText" id="themes"></div>
          </div>
          <div class="preview">
            <div class="previewLabel">Team comparison</div>
            <div class="previewText" id="teams"></div>
          </div>
        </div>

        <div class="sectionTitle">Top Agents This Week</div>
        <div id="overviewLeaderboard"></div>

        <div class="sectionTitle">Recent Activity</div>
        <div id="recentActivity"></div>
      </section>

      <section id="view-queue" style="display:none;">
        <div class="sectionTitle" style="display:flex; justify-content:space-between; align-items:center;">
          <span>Approvals Queue <span id="queueCount" style="font-size:13px; font-weight:400; color:var(--muted);"></span></span>
          <button class="btn success" id="bulkApproveBtn" style="font-size:12px;">Approve All Visible</button>
        </div>

        <div class="preview" style="margin-bottom:14px;">
          <div class="previewLabel">Filters</div>
          <div style="display:grid; grid-template-columns:1.2fr .8fr .8fr .8fr; gap:10px; margin-top:10px;">
            <input class="select" id="qSearch" placeholder="Search text, agent, theme..." />
            <select class="select" id="qSource"></select>
            <select class="select" id="qTeam"></select>
            <select class="select" id="qStatus"></select>
          </div>
        </div>

        <div class="split">
          <div>
            <table class="table" id="queueTable"></table>
          </div>
          <div class="preview">
            <div class="previewLabel">Selected item</div>
            <div class="previewText" id="previewText">Select a row to preview the full text and actions.</div>

            <div class="previewLabel" style="margin-top:14px;">Assign agent</div>
            <select class="select" id="agentSelect"></select>

            <div class="previewLabel" style="margin-top:14px;">Manager Rating (adds to agent score)</div>
            <div style="display:flex; gap:4px; margin-top:6px;" id="managerRatingStars"></div>

            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
              <button class="btn success" id="approveBtn">Approve to TV</button>
              <button class="btn" id="holdBtn">Hold</button>
              <button class="btn danger" id="flagNegBtn">Flag negative</button>
            </div>
          </div>
        </div>
      </section>

      <section id="view-approved" style="display:none;">
        <div class="sectionTitle" style="display:flex; justify-content:space-between; align-items:center;">
          <span>Approved Reviews</span>
          <div style="display:flex; gap:10px;">
            <button class="btn danger" id="resetApprovedBtn" style="font-size:12px;">Reset All to Pending</button>
          </div>
        </div>
        <div class="preview" style="margin-bottom:10px;">
          <div class="previewLabel">Approved items shown on TV Dashboard</div>
          <div class="previewText" style="font-size:12px; color:var(--muted);">These reviews are visible on the TV Dashboard. You can remove individual reviews or reset all back to Pending.</div>
        </div>
        <div id="approvedReviewsList"></div>
      </section>

      <section id="view-agents" style="display:none;">
        <div class="sectionTitle">Agents &amp; Teams</div>
        <div class="split">
          <div>
            <table class="table" id="agentsTable"></table>
          </div>
          <div class="preview">
            <div class="previewLabel">Add New Agent</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
              <input class="select" id="newAgentName" placeholder="Full name" />
              <input class="select" id="newAgentEmail" placeholder="Email" />
            </div>
            <div style="margin-top:10px;">
              <select class="select" id="newAgentTeam"></select>
            </div>
            <button class="btn success" id="addAgentBtn" style="margin-top:12px; width:100%;">+ Add Agent</button>

            <div class="previewLabel" style="margin-top:20px;">Teams</div>
            <div class="previewText" id="teamList"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <input class="select" id="newTeamName" placeholder="New team name" style="flex:1;" />
              <button class="btn" id="addTeamBtn">+ Add</button>
            </div>
          </div>
        </div>
      </section>

      <section id="view-negative" style="display:none;">
        <div class="sectionTitle">Negative Feedback (Internal only)</div>
        <div class="preview">
          <div class="previewLabel">Top negative themes</div>
          <div class="previewText" id="negativeThemes"></div>
        </div>

        <div class="sectionTitle">Negative Reviews</div>
        <div id="negativeReviewsList"></div>

        <div class="sectionTitle" style="margin-top:14px;">Notes</div>
        <div class="preview">
          <div class="previewLabel">Policy</div>
          <div class="previewText">Negative feedback is not shown on the TV dashboard. Items can be reviewed, categorized, and used for coaching and operational improvements.</div>
        </div>
      </section>
      <section id="view-import" style="display:none;">
        <div class="sectionTitle">Import Agents from Excel / CSV</div>
        <div class="split">
          <div class="preview">
            <div class="previewLabel">Upload Agent List</div>
            <div class="previewText" style="font-size:12px; color:var(--muted); margin-bottom:10px;">Upload an <strong>.xlsx, .xls, or .csv</strong> file with agent data. Expected columns: <strong>name</strong> (required), email, team. Columns are auto-detected.</div>
            <input type="file" id="agentFileInput" accept=".xlsx,.xls,.csv" class="select" style="padding:8px;" />
            <button class="btn" id="agentPreviewBtn" style="margin-top:10px; width:100%;">Preview Agents</button>
            <div id="agentPreviewArea" style="margin-top:10px; max-height:320px; overflow:auto; font-size:12px;"></div>
            <button class="btn success" id="agentConfirmBtn" style="margin-top:10px; width:100%; display:none;">Confirm Import</button>
            <div id="agentImportResult" style="margin-top:10px; font-size:12px;"></div>
          </div>
          <div class="preview">
            <div class="previewLabel">Assign Imported Agents to Teams</div>
            <div class="previewText" style="font-size:12px; color:var(--muted); margin-bottom:10px;">After previewing, you can assign a default team to agents that don't have one in the file.</div>
            <div style="margin-bottom:10px;">
              <label style="font-size:11px; color:var(--muted);">Default team for agents without a team column:</label>
              <select class="select" id="agentImportDefaultTeam" style="margin-top:4px;"></select>
            </div>
            <div class="previewLabel" style="margin-top:16px;">Quick Stats</div>
            <div id="agentImportStats" style="font-size:12px; color:var(--muted);">Upload a file to see stats.</div>
          </div>
        </div>

        <div class="sectionTitle" style="margin-top:20px;">Review Sources</div>
        <div class="split">
          <div class="preview">
            <div class="previewLabel">SerpAPI (Active)</div>
            <div class="previewText" style="font-size:12px; color:var(--muted); margin-bottom:10px;">Reviews are scraped automatically via SerpAPI every 12 hours using GitHub Actions. Sorted by newest first.</div>
            <div style="font-size:11px; margin-bottom:6px;">
              <strong>Status:</strong> <span style="color:#22c55e;">Configured</span><br>
              <strong>Schedule:</strong> Every 12 hours (6 AM / 6 PM UTC)<br>
              <strong>Sort:</strong> Newest first<br>
              <strong>Pages per run:</strong> 3 (~30 reviews)
            </div>
            <div class="previewText" style="font-size:11px; color:var(--muted);">To run manually: GitHub repo &rarr; Actions &rarr; "Scrape Google Reviews" &rarr; Run workflow</div>
          </div>
          <div class="preview">
            <div class="previewLabel">Google Places API (Direct)</div>
            <div class="previewText" style="font-size:12px; color:var(--muted); margin-bottom:10px;">Connect directly to Google's Places API for real-time review fetching. Requires a Google Cloud API key with Places API enabled.</div>
            <div style="margin-bottom:8px;">
              <label style="font-size:11px; color:var(--muted);">Google API Key:</label>
              <input class="select" id="googleApiKey" type="password" placeholder="AIza..." style="margin-top:4px; font-size:12px;" />
            </div>
            <div style="margin-bottom:8px;">
              <label style="font-size:11px; color:var(--muted);">Google Place ID:</label>
              <input class="select" id="googlePlaceId" placeholder="ChIJ..." style="margin-top:4px; font-size:12px;" />
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn" id="saveGoogleConfigBtn" style="flex:1;">Save Config</button>
              <button class="btn success" id="fetchGoogleReviewsBtn" style="flex:1;">Fetch Reviews Now</button>
            </div>
            <div id="googleApiResult" style="margin-top:8px; font-size:12px;"></div>
            <div class="previewText" style="font-size:10px; color:var(--muted); margin-top:8px;">
              <strong>Setup:</strong> 1) Go to <a href="https://console.cloud.google.com" target="_blank" style="color:var(--brand);">Google Cloud Console</a>
              2) Enable "Places API" 3) Create an API key 4) Restrict key to Places API only 5) Paste key above
            </div>
          </div>
        </div>

        <div class="sectionTitle" style="margin-top:20px;">Export Reports</div>
        <div class="split">
          <div class="preview">
            <div class="previewLabel">Sentiment Report</div>
            <div class="previewText" style="font-size:12px; color:var(--muted);">Export a summary of sentiment analysis, themes, and agent performance.</div>
            <button class="btn" id="exportSentimentBtn" style="margin-top:10px; width:100%;">Download Sentiment Report (CSV)</button>
          </div>
          <div class="preview">
            <div class="previewLabel">Full Data Export</div>
            <div class="previewText" style="font-size:12px; color:var(--muted);">Export all reviews with full details for external analysis.</div>
            <button class="btn" id="exportFullBtn" style="margin-top:10px; width:100%;">Download All Reviews (CSV)</button>
          </div>
        </div>
      </section>

      <section id="view-settings" style="display:none;">
        <div class="sectionTitle">Admin Portal Theme</div>
        <div class="split">
          <div class="preview">
            <div class="previewLabel">Brand Colour</div>
            <div style="display:flex; gap:12px; align-items:center; margin-top:10px;">
              <input type="color" id="settingBrandColor" style="width:48px; height:48px; border:none; cursor:pointer; background:none;" />
              <div>
                <div style="font-size:13px; font-weight:600;" id="settingBrandHex">#0099cc</div>
                <div style="font-size:11px; color:var(--muted);">Used across admin portal and TV dashboard</div>
              </div>
            </div>
            <div class="previewLabel" style="margin-top:16px;">Quick Presets</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;" id="colorPresets"></div>
          </div>
          <div class="preview">
            <div class="previewLabel">Company Logo URL</div>
            <div style="margin-top:10px;">
              <input class="select" id="settingLogoUrl" placeholder="https://example.com/logo.png" style="font-size:12px;" />
              <div style="margin-top:8px; display:flex; align-items:center; gap:12px;">
                <img id="settingLogoPreview" src="" alt="Logo preview" style="height:40px; max-width:160px; object-fit:contain; display:none;" />
                <span style="font-size:11px; color:var(--muted);" id="settingLogoStatus">Enter a URL to preview</span>
              </div>
            </div>
            <div class="previewLabel" style="margin-top:16px;">Company Name</div>
            <input class="select" id="settingCompanyName" placeholder="Axxess" style="margin-top:8px; font-size:12px;" />
          </div>
        </div>

        <div class="sectionTitle" style="margin-top:20px;">TV Dashboard Customisation</div>
        <div class="split">
          <div class="preview">
            <div class="previewLabel">TV Title &amp; Subtitle</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
              <input class="select" id="settingTvTitle" placeholder="Customer Recognition" style="font-size:12px;" />
              <input class="select" id="settingTvSubtitle" placeholder="Live Dashboard" style="font-size:12px;" />
            </div>

            <div class="previewLabel" style="margin-top:16px;">Background Theme</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;" id="bgThemeOptions"></div>

            <div class="previewLabel" style="margin-top:16px;">Slide Interval (seconds)</div>
            <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
              <input type="range" id="settingSlideInterval" min="4" max="20" value="8" style="flex:1;" />
              <span id="settingSlideLabel" style="font-size:13px; font-weight:600; min-width:30px;">8s</span>
            </div>
          </div>
          <div class="preview">
            <div class="previewLabel">TV Layout</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;" id="tvLayoutOptions"></div>

            <div class="previewLabel" style="margin-top:16px;">Show on TV</div>
            <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">
              <label style="display:flex; align-items:center; gap:8px; font-size:13px; cursor:pointer;"><input type="checkbox" id="settingShowStats" checked /> Stat cards row</label>
              <label style="display:flex; align-items:center; gap:8px; font-size:13px; cursor:pointer;"><input type="checkbox" id="settingShowWeekly" checked /> Weekly leaderboard</label>
              <label style="display:flex; align-items:center; gap:8px; font-size:13px; cursor:pointer;"><input type="checkbox" id="settingShowMonthly" checked /> Monthly leaders</label>
              <label style="display:flex; align-items:center; gap:8px; font-size:13px; cursor:pointer;"><input type="checkbox" id="settingShowHighlights" checked /> Live highlights</label>
              <label style="display:flex; align-items:center; gap:8px; font-size:13px; cursor:pointer;"><input type="checkbox" id="settingShowTicker" checked /> Footer ticker</label>
              <label style="display:flex; align-items:center; gap:8px; font-size:13px; cursor:pointer;"><input type="checkbox" id="settingShowClock" checked /> Clock</label>
            </div>
          </div>
        </div>

        <div class="sectionTitle" style="margin-top:20px;">Ticker Customisation</div>
        <div class="preview">
          <div class="previewLabel">Custom Ticker Message (optional)</div>
          <div style="margin-top:10px;">
            <input class="select" id="settingTickerMsg" placeholder="e.g. Welcome to Axxess â€” Celebrating our amazing team!" style="font-size:12px; width:100%;" />
            <div style="font-size:11px; color:var(--muted); margin-top:4px;">Leave blank to use auto-generated stats ticker. Custom message will be appended to stats.</div>
          </div>
        </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
          <button class="btn success" id="saveSettingsBtn" style="padding:10px 24px;">Save All Settings</button>
          <button class="btn" id="resetSettingsBtn" style="padding:10px 24px;">Reset to Defaults</button>
          <button class="btn primary" id="previewTvBtn" style="padding:10px 24px;">Preview TV Dashboard</button>
        </div>
      </section>

    </main>
  </div>

  <script src="./app.js"></script>
  <script>
(function() {
  var root = document.documentElement;
  var state = loadState();
  root.style.setProperty("--brand", state.brand.primary);

  var views = ["overview", "queue", "approved", "agents", "negative", "import", "settings"];
  var viewTitle = document.getElementById("viewTitle");
  var viewSubtitle = document.getElementById("viewSubtitle");

  var sections = {
    overview: document.getElementById("view-overview"),
    queue: document.getElementById("view-queue"),
    approved: document.getElementById("view-approved"),
    agents: document.getElementById("view-agents"),
    negative: document.getElementById("view-negative"),
    import: document.getElementById("view-import"),
    settings: document.getElementById("view-settings")
  };

  var subtitles = {
    overview: "High level health and pipeline",
    queue: "Review items before they appear on the TV dashboard",
    approved: "Manage approved reviews shown on the TV dashboard",
    agents: "Manage agent directory and team mapping",
    negative: "Internal-only negative feedback themes",
    import: "Import agents, configure review sources, and export reports",
    settings: "Customise admin portal, TV dashboard, and branding"
  };

  function setActive(view) {
    views.forEach(function(v) {
      if (sections[v]) sections[v].style.display = v === view ? "block" : "none";
    });
    document.querySelectorAll("#nav .navItem").forEach(function(a) {
      a.classList.toggle("active", a.getAttribute("data-view") === view);
    });
    var titles = { overview: "Overview", queue: "Approvals Queue", approved: "Approved Reviews", agents: "Agents & Teams", negative: "Negative (Internal)", import: "Import & Config", settings: "Settings" };
    viewTitle.textContent = titles[view] || view;
    viewSubtitle.textContent = subtitles[view] || "";
  }

  function parseHash() {
    var raw = (location.hash || "#overview").replace("#", "");
    return views.indexOf(raw) !== -1 ? raw : "overview";
  }

  window.addEventListener("hashchange", function() { setActive(parseHash()); });
  setActive(parseHash());

  var kpis = document.getElementById("kpis");
  var themes = document.getElementById("themes");
  var teams = document.getElementById("teams");
  var selectedId = null;

  var queueTable = document.getElementById("queueTable");
  var previewText = document.getElementById("previewText");
  var agentSelect = document.getElementById("agentSelect");
  var qSearch = document.getElementById("qSearch");
  var qSource = document.getElementById("qSource");
  var qTeam = document.getElementById("qTeam");
  var qStatus = document.getElementById("qStatus");

  function renderAgentSelect(current) {
    var options = ["Unknown"].concat(state.agents.map(function(a) { return a.name; }));
    agentSelect.innerHTML = options.map(function(n) { return '<option value="' + n + '">' + n + '</option>'; }).join("");
    agentSelect.value = current || "Unknown";
  }

  function rowBadge(text) {
    return '<span class="pill">' + String(text || "") + '</span>';
  }

  function populateFilters() {
    var savedSource = qSource ? qSource.value : "All";
    var savedTeam = qTeam ? qTeam.value : "All";
    var savedStatus = qStatus ? qStatus.value : "All";

    if (qSource) {
      var sources = ["All"].concat(Array.from(new Set(state.items.map(function(i) { return i.source; }))).sort());
      qSource.innerHTML = sources.map(function(s) { return '<option value="' + s + '"' + (s === savedSource ? ' selected' : '') + '>' + s + '</option>'; }).join("");
    }
    if (qTeam) {
      var teamsList = ["All"].concat(state.teams);
      qTeam.innerHTML = teamsList.map(function(t) { return '<option value="' + t + '"' + (t === savedTeam ? ' selected' : '') + '>' + t + '</option>'; }).join("");
    }
    if (qStatus) {
      var statuses = ["All", "Pending", "On hold"];
      qStatus.innerHTML = statuses.map(function(s) { return '<option value="' + s + '"' + (s === savedStatus ? ' selected' : '') + '>' + s + '</option>'; }).join("");
    }
  }

  function getFilteredQueue() {
    var search = (qSearch && qSearch.value || "").trim().toLowerCase();
    var source = qSource && qSource.value || "All";
    var team = qTeam && qTeam.value || "All";
    var status = qStatus && qStatus.value || "All";

    return state.items
      .filter(function(i) { return i.status === "Pending" || i.status === "On hold"; })
      .filter(function(i) { return source === "All" || i.source === source; })
      .filter(function(i) { return team === "All" || i.team === team; })
      .filter(function(i) { return status === "All" || i.status === status; })
      .filter(function(i) {
        if (!search) return true;
        var blob = (i.id + " " + i.source + " " + i.sentiment + " " + i.status + " " + i.agent + " " + i.team + " " + i.theme + " " + i.text).toLowerCase();
        return blob.indexOf(search) !== -1;
      })
      .sort(function(a, b) { return new Date(b.createdAt) - new Date(a.createdAt); });
  }

  function renderQueue() {
    var items = getFilteredQueue();
    if (!selectedId && items[0]) selectedId = items[0].id;

    var countEl = document.getElementById("queueCount");
    var pendingCount = items.filter(function(i) { return i.status === "Pending"; }).length;
    if (countEl) countEl.textContent = "(" + items.length + " items, " + pendingCount + " pending)";

    queueTable.innerHTML = '<thead><tr><th>Date</th><th>Source</th><th>Rating</th><th>Sentiment</th><th>Agent</th><th>Team</th><th>Status</th></tr></thead><tbody>' +
      items.map(function(q) {
        var rating = q.rating == null ? "â€”" : q.rating + "/5";
        var isSelected = q.id === selectedId;
        var d = new Date(q.createdAt);
        var dateLabel = isNaN(d.getTime()) ? q.createdAt : d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
        return '<tr data-id="' + q.id + '" style="cursor:pointer; background:' + (isSelected ? "rgba(11,126,168,.15)" : "transparent") + '"><td>' + dateLabel + '</td><td>' + rowBadge(q.source) + '</td><td>' + rating + '</td><td>' + rowBadge(q.sentiment) + '</td><td>' + q.agent + '</td><td>' + q.team + '</td><td>' + rowBadge(q.status) + '</td></tr>';
      }).join("") + '</tbody>';

    queueTable.querySelectorAll("tbody tr").forEach(function(tr) {
      tr.addEventListener("click", function() {
        selectedId = tr.getAttribute("data-id");
        renderQueue();
        renderPreview();
      });
    });
  }

  var managerRatingStars = document.getElementById("managerRatingStars");

  function renderManagerRating(currentRating) {
    var html = "";
    for (var i = 1; i <= 5; i++) {
      var color = i <= (currentRating || 0) ? "#fbbf24" : "#4b5563";
      html += '<span data-star="' + i + '" style="cursor:pointer; font-size:24px; color:' + color + '; transition:color 0.15s;">â˜…</span>';
    }
    html += currentRating ? ' <span style="font-size:12px; color:var(--muted); margin-left:6px;">' + currentRating + '/5</span>' : ' <span style="font-size:12px; color:var(--muted); margin-left:6px;">Not rated</span>';
    managerRatingStars.innerHTML = html;

    managerRatingStars.querySelectorAll("[data-star]").forEach(function(star) {
      star.addEventListener("click", function() {
        var item = state.items.find(function(q) { return q.id === selectedId; });
        if (!item) { showToast("Select an item first", "error"); return; }
        var val = parseInt(star.getAttribute("data-star"));
        state = updateItem(item.id, { managerRating: val });
        renderManagerRating(val);
        showToast("Manager rating: " + val + "/5 (+" + (val * 6) + " score points)", "success");
      });
    });
  }

  function renderPreview() {
    var item = state.items.find(function(q) { return q.id === selectedId; });
    if (!item) {
      previewText.textContent = "Select a row to preview the full text and actions.";
      renderAgentSelect("Unknown");
      renderManagerRating(null);
      return;
    }
    previewText.textContent = item.text;
    renderAgentSelect(item.agent);
    renderManagerRating(item.managerRating);
  }

  function updateSelectedStatus(status) {
    var item = state.items.find(function(q) { return q.id === selectedId; });
    if (!item) {
      showToast("Please select an item first", "error");
      return;
    }
    var patch = { status: status };
    if (status === "Flagged (Negative)") patch.sentiment = "Negative";
    state = updateItem(item.id, patch);
    renderAll();
    showToast("Item " + item.id + " â†’ " + status, "success");
  }

  document.getElementById("approveBtn").addEventListener("click", function() { updateSelectedStatus("Approved"); });
  document.getElementById("holdBtn").addEventListener("click", function() { updateSelectedStatus("On hold"); });
  document.getElementById("flagNegBtn").addEventListener("click", function() { updateSelectedStatus("Flagged (Negative)"); });

  // Bulk approve all visible pending items
  document.getElementById("bulkApproveBtn").addEventListener("click", function() {
    var items = getFilteredQueue().filter(function(i) { return i.status === "Pending"; });
    if (items.length === 0) { showToast("No pending items to approve", "error"); return; }
    if (!confirm("Approve all " + items.length + " pending items in the current view?")) return;
    items.forEach(function(item) { state = updateItem(item.id, { status: "Approved" }); });
    renderAll();
    showToast("Approved " + items.length + " items", "success");
  });

  agentSelect.addEventListener("change", function() {
    var item = state.items.find(function(q) { return q.id === selectedId; });
    if (!item) return;
    var nextAgent = agentSelect.value;
    var agent = state.agents.find(function(a) { return a.name === nextAgent; });
    state = updateItem(item.id, { agent: nextAgent, team: agent ? agent.team : "Unknown" });
    renderAll();
    showToast("Assigned to " + nextAgent, "success");
  });

  if (qSearch) qSearch.addEventListener("input", function() { renderAll(); });
  if (qSource) qSource.addEventListener("change", function() { renderAll(); });
  if (qTeam) qTeam.addEventListener("change", function() { renderAll(); });
  if (qStatus) qStatus.addEventListener("change", function() { renderAll(); });

  // --- AGENTS & TEAMS CRUD ---
  var agentsTable = document.getElementById("agentsTable");
  var teamList = document.getElementById("teamList");
  var newAgentTeam = document.getElementById("newAgentTeam");

  function getAgentScore(agentName) {
    var total = 0;
    state.items.forEach(function(it) {
      if (it.agent === agentName) total += scoreItem(it);
    });
    return Math.round(total);
  }

  function getAgentReviewCount(agentName) {
    return state.items.filter(function(it) { return it.agent === agentName && it.status === "Approved"; }).length;
  }

  var editingAgentId = null;

  function renderAgents() {
    var teamOptions = state.teams.map(function(t) { return '<option value="' + t + '">' + t + '</option>'; }).join("");

    agentsTable.innerHTML = '<thead><tr><th>Name</th><th>Team</th><th>Email</th><th>Reviews</th><th>Score</th><th style="width:140px;">Actions</th></tr></thead><tbody>' +
      state.agents.map(function(a) {
        var score = getAgentScore(a.name);
        var reviews = getAgentReviewCount(a.name);
        var scoreColor = score > 100 ? "#22c55e" : score > 0 ? "#f59e0b" : "#64748b";
        var email = a.email || "";

        if (editingAgentId === a.id) {
          return '<tr style="background:rgba(0,153,204,.08);">' +
            '<td><input class="select" data-edit-name="' + a.id + '" value="' + a.name + '" style="padding:4px 8px; font-size:12px; width:100%;" /></td>' +
            '<td><select class="select" data-edit-team="' + a.id + '" style="padding:4px 8px; font-size:12px;">' + teamOptions.replace('value="' + a.team + '"', 'value="' + a.team + '" selected') + '</select></td>' +
            '<td><input class="select" data-edit-email="' + a.id + '" value="' + email + '" style="padding:4px 8px; font-size:12px; width:100%;" /></td>' +
            '<td>' + reviews + '</td><td style="color:' + scoreColor + '; font-weight:700;">' + score + '</td>' +
            '<td><button class="btn success" data-save-agent="' + a.id + '" style="padding:4px 8px; font-size:11px; margin-right:4px;">Save</button><button class="btn" data-cancel-edit style="padding:4px 8px; font-size:11px;">Cancel</button></td></tr>';
        }

        return '<tr><td>' + a.name + '</td><td>' + rowBadge(a.team) + '</td><td>' + (email || '<span style="color:var(--muted);">\u2014</span>') + '</td><td>' + reviews + '</td><td style="color:' + scoreColor + '; font-weight:700;">' + score + '</td>' +
          '<td><button class="btn" data-edit-agent="' + a.id + '" style="padding:4px 8px; font-size:11px; margin-right:4px;">Edit</button><button class="btn danger" data-delete-agent="' + a.id + '" style="padding:4px 8px; font-size:11px;">Remove</button></td></tr>';
      }).join("") + '</tbody>';

    teamList.innerHTML = state.teams.map(function(t) {
      var count = state.agents.filter(function(a) { return a.team === t; }).length;
      return '<span class="themeChip">' + t + ' (' + count + ') <span data-delete-team="' + t + '" style="cursor:pointer; margin-left:4px; color:#f87171;" title="Delete team">&times;</span></span>';
    }).join(" ");

    if (newAgentTeam) {
      newAgentTeam.innerHTML = state.teams.map(function(t) { return '<option value="' + t + '">' + t + '</option>'; }).join("");
    }

    // Bind edit buttons
    agentsTable.querySelectorAll("[data-edit-agent]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        editingAgentId = btn.getAttribute("data-edit-agent");
        renderAgents();
      });
    });

    // Bind save buttons
    agentsTable.querySelectorAll("[data-save-agent]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var id = btn.getAttribute("data-save-agent");
        var nameInput = agentsTable.querySelector('[data-edit-name="' + id + '"]');
        var teamInput = agentsTable.querySelector('[data-edit-team="' + id + '"]');
        var emailInput = agentsTable.querySelector('[data-edit-email="' + id + '"]');
        var agent = state.agents.find(function(a) { return a.id === id; });
        if (!agent) return;
        var oldName = agent.name;
        agent.name = (nameInput.value || "").trim() || agent.name;
        agent.team = teamInput.value;
        agent.email = (emailInput.value || "").trim();
        // Update reviews assigned to old name
        if (oldName !== agent.name) {
          state.items.forEach(function(it) { if (it.agent === oldName) it.agent = agent.name; });
        }
        editingAgentId = null;
        saveState(state);
        renderAll();
        showToast("Updated " + agent.name, "success");
      });
    });

    // Bind cancel buttons
    agentsTable.querySelectorAll("[data-cancel-edit]").forEach(function(btn) {
      btn.addEventListener("click", function() { editingAgentId = null; renderAgents(); });
    });

    // Bind delete agent buttons
    agentsTable.querySelectorAll("[data-delete-agent]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var agentId = btn.getAttribute("data-delete-agent");
        var agent = state.agents.find(function(a) { return a.id === agentId; });
        if (!agent) return;
        if (!confirm("Remove agent " + agent.name + "?")) return;
        state.agents = state.agents.filter(function(a) { return a.id !== agentId; });
        saveState(state);
        renderAll();
        showToast("Removed " + agent.name, "success");
      });
    });

    // Bind delete team buttons
    teamList.querySelectorAll("[data-delete-team]").forEach(function(span) {
      span.addEventListener("click", function(e) {
        e.stopPropagation();
        var teamName = span.getAttribute("data-delete-team");
        var agentsInTeam = state.agents.filter(function(a) { return a.team === teamName; }).length;
        if (agentsInTeam > 0) { showToast("Cannot delete team with " + agentsInTeam + " agent(s). Reassign them first.", "error"); return; }
        if (!confirm("Delete team '" + teamName + "'?")) return;
        state.teams = state.teams.filter(function(t) { return t !== teamName; });
        saveState(state);
        renderAll();
        showToast("Deleted team " + teamName, "success");
      });
    });
  }

  // Add Agent button
  document.getElementById("addAgentBtn").addEventListener("click", function() {
    var nameEl = document.getElementById("newAgentName");
    var emailEl = document.getElementById("newAgentEmail");
    var teamEl = document.getElementById("newAgentTeam");
    var name = (nameEl.value || "").trim();
    var email = (emailEl.value || "").trim();
    var team = teamEl.value;

    if (!name) { showToast("Please enter agent name", "error"); return; }
    if (!email) { showToast("Please enter agent email", "error"); return; }
    if (!team) { showToast("Please select a team", "error"); return; }

    var id = "AG-" + String(Date.now()).slice(-6);
    state.agents.push({ id: id, name: name, team: team, email: email });
    saveState(state);
    nameEl.value = "";
    emailEl.value = "";
    renderAll();
    showToast("Added agent " + name, "success");
  });

  // Add Team button
  document.getElementById("addTeamBtn").addEventListener("click", function() {
    var teamInput = document.getElementById("newTeamName");
    var teamName = (teamInput.value || "").trim();
    if (!teamName) { showToast("Please enter a team name", "error"); return; }
    if (state.teams.indexOf(teamName) !== -1) { showToast("Team already exists", "error"); return; }
    state.teams.push(teamName);
    saveState(state);
    teamInput.value = "";
    renderAll();
    showToast("Added team " + teamName, "success");
  });

  // --- APPROVED REVIEWS MANAGEMENT ---
  var approvedReviewsList = document.getElementById("approvedReviewsList");

  function renderApproved() {
    var approved = state.items.filter(function(i) { return i.status === "Approved" && i.sentiment !== "Negative"; });
    approved.sort(function(a, b) { return new Date(b.createdAt) - new Date(a.createdAt); });

    approvedReviewsList.innerHTML = approved.length ? approved.map(function(item) {
      var d = new Date(item.createdAt);
      var dateLabel = isNaN(d.getTime()) ? item.createdAt : d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
      var ratingStr = item.rating != null ? item.rating + "/5" : "â€”";
      var reviewer = item.reviewerName || "Unknown";
      var agentLabel = item.agent && item.agent !== "Unknown" ? ' Â· Agent: <strong>' + item.agent + '</strong>' : '';
      var mgrRating = item.managerRating ? ' Â· Mgr: ' + item.managerRating + '/5' : '';
      var textPreview = item.text.length > 200 ? item.text.substring(0, 200) + "..." : item.text;
      return '<div class="preview" style="margin-bottom:10px;">' +
        '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">' +
          '<div><strong>' + reviewer + '</strong> Â· ' + rowBadge(item.source) + ' Â· ' + rowBadge(ratingStr) + ' Â· ' + rowBadge(item.theme || "General") + agentLabel + mgrRating + '</div>' +
          '<div style="display:flex; gap:8px; align-items:center;">' +
            '<span style="color:var(--muted); font-size:12px;">' + dateLabel + '</span>' +
            '<button class="btn danger" data-unapprove="' + item.id + '" style="padding:4px 10px; font-size:11px;">Remove from TV</button>' +
            '<button class="btn" data-delete-review="' + item.id + '" style="padding:4px 10px; font-size:11px;">Delete</button>' +
          '</div>' +
        '</div>' +
        '<div class="previewText" style="font-size:13px; line-height:1.5;">' + textPreview + '</div>' +
      '</div>';
    }).join("") : '<div class="preview"><div class="previewText" style="color:var(--muted);">No approved reviews yet. Approve items from the Queue to see them here and on the TV Dashboard.</div></div>';

    // Bind unapprove buttons (set back to Pending)
    approvedReviewsList.querySelectorAll("[data-unapprove]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var id = btn.getAttribute("data-unapprove");
        state = updateItem(id, { status: "Pending" });
        renderAll();
        showToast("Moved back to Pending", "success");
      });
    });

    // Bind delete buttons (permanently remove)
    approvedReviewsList.querySelectorAll("[data-delete-review]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var id = btn.getAttribute("data-delete-review");
        var item = state.items.find(function(i) { return i.id === id; });
        if (!item) return;
        if (!confirm("Permanently delete this review?")) return;
        state.items = state.items.filter(function(i) { return i.id !== id; });
        saveState(state);
        renderAll();
        showToast("Review deleted", "success");
      });
    });
  }

  // Reset All Approved to Pending
  document.getElementById("resetApprovedBtn").addEventListener("click", function() {
    var approved = state.items.filter(function(i) { return i.status === "Approved" && i.sentiment !== "Negative"; });
    if (approved.length === 0) { showToast("No approved reviews to reset", "error"); return; }
    if (!confirm("Reset all " + approved.length + " approved reviews back to Pending?")) return;
    approved.forEach(function(item) {
      state = updateItem(item.id, { status: "Pending" });
    });
    renderAll();
    showToast(approved.length + " reviews reset to Pending", "success");
  });

  // --- NEGATIVE TAB ---
  var negativeThemes = document.getElementById("negativeThemes");
  var negativeReviewsList = document.getElementById("negativeReviewsList");

  function renderNegative() {
    var neg = state.items.filter(function(i) { return i.sentiment === "Negative" || i.status === "Flagged (Negative)"; });

    // Theme summary
    var map = {};
    neg.forEach(function(it) {
      var key = it.theme || "Uncategorized";
      map[key] = (map[key] || 0) + 1;
    });
    var rows = Object.keys(map).map(function(k) { return [k, map[k]]; }).sort(function(a, b) { return b[1] - a[1]; });
    negativeThemes.innerHTML = rows.length ? rows.map(function(r) {
      return '<div style="display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06);"><span>' + r[0] + '</span><span style="color:var(--muted); font-weight:900;">' + r[1] + '</span></div>';
    }).join("") : '<div style="color:var(--muted);">No negative themes found.</div>';

    // Individual negative reviews
    neg.sort(function(a, b) { return new Date(b.createdAt) - new Date(a.createdAt); });
    negativeReviewsList.innerHTML = neg.length ? neg.map(function(item) {
      var d = new Date(item.createdAt);
      var dateLabel = isNaN(d.getTime()) ? item.createdAt : d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
      var ratingStr = item.rating != null ? item.rating + "/5" : "â€”";
      var reviewer = item.reviewerName || item.agent || "Unknown";
      var textPreview = item.text.length > 300 ? item.text.substring(0, 300) + "..." : item.text;
      return '<div class="preview" style="margin-bottom:10px;">' +
        '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">' +
          '<div><strong>' + reviewer + '</strong> Â· ' + rowBadge(item.source) + ' Â· ' + rowBadge(ratingStr) + ' Â· ' + rowBadge(item.theme || "Uncategorized") + ' Â· Agent: <strong>' + item.agent + '</strong></div>' +
          '<div style="display:flex; gap:6px; align-items:center;">' +
            '<span style="color:var(--muted); font-size:12px;">' + dateLabel + '</span>' +
            '<button class="btn" data-neg-resolve="' + item.id + '" style="padding:4px 8px; font-size:11px;">Move to Pending</button>' +
            '<button class="btn danger" data-neg-delete="' + item.id + '" style="padding:4px 8px; font-size:11px;">Delete</button>' +
          '</div>' +
        '</div>' +
        '<div class="previewText" style="font-size:13px; line-height:1.5;">' + textPreview + '</div>' +
        '<div style="margin-top:8px; display:flex; gap:6px;">' +
          (item.keywords || []).map(function(k) { return '<span class="themeChip">' + k + '</span>'; }).join("") +
        '</div>' +
      '</div>';
    }).join("") : '<div class="preview"><div class="previewText" style="color:var(--muted);">No negative reviews found. Reviews with negative sentiment or flagged status will appear here.</div></div>';

    // Bind negative review actions
    negativeReviewsList.querySelectorAll("[data-neg-resolve]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var id = btn.getAttribute("data-neg-resolve");
        state = updateItem(id, { status: "Pending", sentiment: "Neutral" });
        renderAll();
        showToast("Moved to Pending queue", "success");
      });
    });
    negativeReviewsList.querySelectorAll("[data-neg-delete]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var id = btn.getAttribute("data-neg-delete");
        if (!confirm("Permanently delete this negative review?")) return;
        state.items = state.items.filter(function(i) { return i.id !== id; });
        saveState(state);
        renderAll();
        showToast("Review deleted", "success");
      });
    });
  }

  // --- OVERVIEW ---
  function renderOverview() {
    var stats = computeStats(state);
    var approvedCount = state.items.filter(function(i) { return i.status === "Approved"; }).length;
    var googleCount = state.items.filter(function(i) { return i.source === "Google"; }).length;
    var kpiMap = [
      { label: "Total reviews", value: state.items.length },
      { label: "Approved / On TV", value: approvedCount },
      { label: "Pending approvals", value: stats.pending },
      { label: "Avg sentiment", value: stats.avgSentiment },
      { label: "Negative flagged", value: stats.negativeFlagged },
      { label: "Agents", value: state.agents.length },
      { label: "Google reviews", value: googleCount },
      { label: "Teams", value: state.teams.length }
    ];
    kpis.innerHTML = kpiMap.map(function(k) {
      return '<div class="kpi"><div class="kpiLabel">' + k.label + '</div><div class="kpiValue">' + k.value + '</div></div>';
    }).join("");

    var lb = computeLeaderboards(state, new Date());
    var topThemes = [];
    lb.weeklyTop.forEach(function(a) { (a.themes || []).forEach(function(t) { if (topThemes.indexOf(t) === -1) topThemes.push(t); }); });
    themes.textContent = topThemes.length ? topThemes.slice(0, 6).join(", ") : "No themes yet â€” approve items to see themes";

    var byTeam = {};
    state.items.filter(function(i) { return i.status === "Approved" && i.sentiment !== "Negative"; }).forEach(function(it) {
      byTeam[it.team] = (byTeam[it.team] || 0) + 1;
    });
    var teamPairs = Object.keys(byTeam).map(function(t) { return [t, byTeam[t]]; }).sort(function(a, b) { return b[1] - a[1]; });
    teams.textContent = teamPairs.map(function(p) { return p[0] + ": " + p[1]; }).join(" Â· ") || "No approved items yet";

    // Mini leaderboard
    var leaderboardEl = document.getElementById("overviewLeaderboard");
    if (leaderboardEl) {
      if (lb.weeklyTop.length > 0) {
        leaderboardEl.innerHTML = '<div class="split">' + lb.weeklyTop.slice(0, 5).map(function(agent, idx) {
          var medal = idx === 0 ? "ðŸ¥‡" : idx === 1 ? "ðŸ¥ˆ" : idx === 2 ? "ðŸ¥‰" : "#" + (idx + 1);
          return '<div class="preview" style="text-align:center; padding:12px;">' +
            '<div style="font-size:20px; margin-bottom:4px;">' + medal + '</div>' +
            '<div style="font-weight:800;">' + agent.name + '</div>' +
            '<div style="font-size:12px; color:var(--muted);">' + agent.team + '</div>' +
            '<div style="font-size:18px; font-weight:900; color:var(--brand); margin-top:4px;">' + agent.score + ' pts</div>' +
            '<div style="font-size:11px; color:var(--muted);">' + agent.count + ' reviews</div>' +
          '</div>';
        }).join("") + '</div>';
      } else {
        leaderboardEl.innerHTML = '<div class="preview"><div class="previewText" style="color:var(--muted);">No approved reviews this week. Approve items from the Queue to see the leaderboard.</div></div>';
      }
    }

    // Recent activity
    var recentEl = document.getElementById("recentActivity");
    if (recentEl) {
      var recent = state.items.slice().sort(function(a, b) { return new Date(b.createdAt) - new Date(a.createdAt); }).slice(0, 5);
      if (recent.length > 0) {
        recentEl.innerHTML = recent.map(function(item) {
          var d = new Date(item.createdAt);
          var dateLabel = isNaN(d.getTime()) ? "" : d.toLocaleDateString(undefined, { month: "short", day: "2-digit" }) + " " + d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
          var reviewer = item.reviewerName || item.agent || "Unknown";
          var snippet = item.text.length > 100 ? item.text.substring(0, 100) + "..." : item.text;
          return '<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 12px; border-bottom:1px solid var(--border);">' +
            '<div style="flex:1;"><strong>' + reviewer + '</strong> ' + rowBadge(item.source) + ' ' + rowBadge(item.status) + '<div style="font-size:12px; color:var(--muted); margin-top:2px;">' + snippet + '</div></div>' +
            '<div style="font-size:11px; color:var(--muted); white-space:nowrap; margin-left:12px;">' + dateLabel + '</div>' +
          '</div>';
        }).join("");
      } else {
        recentEl.innerHTML = '<div class="preview"><div class="previewText" style="color:var(--muted);">No reviews yet.</div></div>';
      }
    }
  }

  // --- RENDER ALL ---
  function renderAll() {
    state = loadState();
    root.style.setProperty("--brand", state.brand.primary);
    populateFilters();
    renderOverview();
    renderQueue();
    renderPreview();
    renderAgents();
    renderApproved();
    renderNegative();
    renderAgentImportTeams();

    var helpBanner = document.getElementById("helpBanner");
    if (helpBanner) helpBanner.style.display = state.items.length === 0 ? "block" : "none";
  }

  renderAll();

  // --- SETTINGS ---
  var TV_CONFIG_KEY = "axxess_tv_config";

  var defaultTvConfig = {
    brandColor: "#0099cc",
    logoUrl: "https://i.ibb.co/fGy3TCJd/logo-axxess-1.png",
    companyName: "Axxess",
    tvTitle: "Customer Recognition",
    tvSubtitle: "",
    bgTheme: "dark",
    layout: "default",
    slideInterval: 8,
    showStats: true,
    showWeekly: true,
    showMonthly: true,
    showHighlights: true,
    showTicker: true,
    showClock: true,
    tickerMsg: ""
  };

  function loadTvConfig() {
    try { var c = JSON.parse(localStorage.getItem(TV_CONFIG_KEY)); return Object.assign({}, defaultTvConfig, c || {}); } catch(e) { return Object.assign({}, defaultTvConfig); }
  }

  function saveTvConfig(cfg) {
    localStorage.setItem(TV_CONFIG_KEY, JSON.stringify(cfg));
  }

  var tvConfig = loadTvConfig();

  // Color presets
  var presetColors = [
    { label: "Axxess Blue", color: "#0099cc" },
    { label: "Ocean", color: "#0ea5e9" },
    { label: "Emerald", color: "#10b981" },
    { label: "Purple", color: "#8b5cf6" },
    { label: "Rose", color: "#f43f5e" },
    { label: "Amber", color: "#f59e0b" },
    { label: "Indigo", color: "#6366f1" },
    { label: "Teal", color: "#14b8a6" },
    { label: "Slate", color: "#64748b" },
    { label: "Orange", color: "#f97316" }
  ];

  var bgThemes = [
    { id: "dark", label: "Dark Navy", colors: "#0f172a â†’ #1e293b" },
    { id: "midnight", label: "Midnight", colors: "#020617 â†’ #0f172a" },
    { id: "charcoal", label: "Charcoal", colors: "#18181b â†’ #27272a" },
    { id: "ocean", label: "Deep Ocean", colors: "#0c1222 â†’ #162032" },
    { id: "forest", label: "Forest", colors: "#052e16 â†’ #14532d" },
    { id: "wine", label: "Wine", colors: "#1c0a1a â†’ #2d1228" }
  ];

  var tvLayouts = [
    { id: "default", label: "Default (Leaderboard + Highlights)" },
    { id: "highlights-only", label: "Highlights Only (Full Width)" },
    { id: "leaderboard-only", label: "Leaderboard Only (Full Width)" }
  ];

  function renderSettings() {
    var cfg = tvConfig;

    // Brand color
    var brandInput = document.getElementById("settingBrandColor");
    brandInput.value = cfg.brandColor;
    document.getElementById("settingBrandHex").textContent = cfg.brandColor;

    brandInput.addEventListener("input", function() {
      document.getElementById("settingBrandHex").textContent = brandInput.value;
    });

    // Color presets
    document.getElementById("colorPresets").innerHTML = presetColors.map(function(p) {
      var isActive = cfg.brandColor.toLowerCase() === p.color.toLowerCase();
      return '<div data-preset-color="' + p.color + '" style="cursor:pointer; width:36px; height:36px; border-radius:8px; background:' + p.color + '; border:2px solid ' + (isActive ? 'white' : 'transparent') + '; display:flex; align-items:center; justify-content:center;" title="' + p.label + '">' + (isActive ? '<span style="color:white; font-size:14px;">âœ“</span>' : '') + '</div>';
    }).join("");

    document.querySelectorAll("[data-preset-color]").forEach(function(el) {
      el.addEventListener("click", function() {
        brandInput.value = el.getAttribute("data-preset-color");
        document.getElementById("settingBrandHex").textContent = brandInput.value;
        renderSettings();
      });
    });

    // Logo
    var logoInput = document.getElementById("settingLogoUrl");
    logoInput.value = cfg.logoUrl;
    var logoPreview = document.getElementById("settingLogoPreview");
    var logoStatus = document.getElementById("settingLogoStatus");
    if (cfg.logoUrl) {
      logoPreview.src = cfg.logoUrl;
      logoPreview.style.display = "block";
      logoStatus.textContent = "Logo loaded";
    }
    logoInput.addEventListener("input", function() {
      var url = logoInput.value.trim();
      if (url) {
        logoPreview.src = url;
        logoPreview.style.display = "block";
        logoPreview.onerror = function() { logoPreview.style.display = "none"; logoStatus.textContent = "Failed to load image"; };
        logoPreview.onload = function() { logoStatus.textContent = "Logo loaded"; };
      } else {
        logoPreview.style.display = "none";
        logoStatus.textContent = "Enter a URL to preview";
      }
    });

    // Company name
    document.getElementById("settingCompanyName").value = cfg.companyName;

    // TV title/subtitle
    document.getElementById("settingTvTitle").value = cfg.tvTitle;
    document.getElementById("settingTvSubtitle").value = cfg.tvSubtitle;

    // Background theme
    document.getElementById("bgThemeOptions").innerHTML = bgThemes.map(function(t) {
      var isActive = cfg.bgTheme === t.id;
      return '<div data-bg-theme="' + t.id + '" style="cursor:pointer; padding:8px 14px; border-radius:8px; border:2px solid ' + (isActive ? 'var(--brand)' : 'var(--border)') + '; background:' + (isActive ? 'rgba(0,153,204,.1)' : 'transparent') + '; font-size:12px;">' +
        '<div style="font-weight:600;">' + t.label + '</div>' +
        '<div style="font-size:10px; color:var(--muted);">' + t.colors + '</div></div>';
    }).join("");

    document.querySelectorAll("[data-bg-theme]").forEach(function(el) {
      el.addEventListener("click", function() {
        cfg.bgTheme = el.getAttribute("data-bg-theme");
        renderSettings();
      });
    });

    // Layout
    document.getElementById("tvLayoutOptions").innerHTML = tvLayouts.map(function(l) {
      var isActive = cfg.layout === l.id;
      return '<div data-tv-layout="' + l.id + '" style="cursor:pointer; padding:8px 14px; border-radius:8px; border:2px solid ' + (isActive ? 'var(--brand)' : 'var(--border)') + '; background:' + (isActive ? 'rgba(0,153,204,.1)' : 'transparent') + '; font-size:12px; font-weight:' + (isActive ? '600' : '400') + ';">' + l.label + '</div>';
    }).join("");

    document.querySelectorAll("[data-tv-layout]").forEach(function(el) {
      el.addEventListener("click", function() {
        cfg.layout = el.getAttribute("data-tv-layout");
        renderSettings();
      });
    });

    // Slide interval
    var slider = document.getElementById("settingSlideInterval");
    slider.value = cfg.slideInterval;
    document.getElementById("settingSlideLabel").textContent = cfg.slideInterval + "s";
    slider.addEventListener("input", function() {
      document.getElementById("settingSlideLabel").textContent = slider.value + "s";
    });

    // Checkboxes
    document.getElementById("settingShowStats").checked = cfg.showStats;
    document.getElementById("settingShowWeekly").checked = cfg.showWeekly;
    document.getElementById("settingShowMonthly").checked = cfg.showMonthly;
    document.getElementById("settingShowHighlights").checked = cfg.showHighlights;
    document.getElementById("settingShowTicker").checked = cfg.showTicker;
    document.getElementById("settingShowClock").checked = cfg.showClock;

    // Ticker
    document.getElementById("settingTickerMsg").value = cfg.tickerMsg;
  }

  renderSettings();

  // Save settings
  document.getElementById("saveSettingsBtn").addEventListener("click", function() {
    tvConfig = {
      brandColor: document.getElementById("settingBrandColor").value,
      logoUrl: document.getElementById("settingLogoUrl").value.trim(),
      companyName: document.getElementById("settingCompanyName").value.trim() || "Axxess",
      tvTitle: document.getElementById("settingTvTitle").value.trim() || "Customer Recognition",
      tvSubtitle: document.getElementById("settingTvSubtitle").value.trim(),
      bgTheme: tvConfig.bgTheme,
      layout: tvConfig.layout,
      slideInterval: parseInt(document.getElementById("settingSlideInterval").value) || 8,
      showStats: document.getElementById("settingShowStats").checked,
      showWeekly: document.getElementById("settingShowWeekly").checked,
      showMonthly: document.getElementById("settingShowMonthly").checked,
      showHighlights: document.getElementById("settingShowHighlights").checked,
      showTicker: document.getElementById("settingShowTicker").checked,
      showClock: document.getElementById("settingShowClock").checked,
      tickerMsg: document.getElementById("settingTickerMsg").value.trim()
    };
    saveTvConfig(tvConfig);

    // Also update admin brand color
    state = updateBrandPrimary(tvConfig.brandColor);
    root.style.setProperty("--brand", tvConfig.brandColor);
    renderAll();
    renderSettings();
    showToast("All settings saved. TV dashboard will update on next refresh.", "success");
  });

  // Reset settings
  document.getElementById("resetSettingsBtn").addEventListener("click", function() {
    if (!confirm("Reset all settings to defaults?")) return;
    tvConfig = Object.assign({}, defaultTvConfig);
    saveTvConfig(tvConfig);
    state = updateBrandPrimary(tvConfig.brandColor);
    root.style.setProperty("--brand", tvConfig.brandColor);
    renderAll();
    renderSettings();
    showToast("Settings reset to defaults", "success");
  });

  // Preview TV
  document.getElementById("previewTvBtn").addEventListener("click", function() {
    // Save first
    document.getElementById("saveSettingsBtn").click();
    setTimeout(function() { window.open("./tv.html", "_blank"); }, 200);
  });

  // --- RESET ---
  var resetBtn = document.getElementById("resetBtn");
  if (resetBtn) {
    resetBtn.addEventListener("click", function() {
      if (!confirm("Reset all data? This will clear all reviews, agents, and settings.")) return;
      localStorage.removeItem(GOOGLE_REVIEWS_LOADED_KEY);
      state = resetState();
      root.style.setProperty("--brand", state.brand.primary);
      renderAll();
      showToast("Data reset. Refresh page to reload Google reviews.", "success");
    });
  }

  // --- AGENT IMPORT ---

  function findColIdx(headers, names) {
    for (var n = 0; n < names.length; n++) {
      var idx = headers.indexOf(names[n]);
      if (idx >= 0) return idx;
    }
    for (var n = 0; n < names.length; n++) {
      for (var h = 0; h < headers.length; h++) {
        if (headers[h].indexOf(names[n]) >= 0) return h;
      }
    }
    return -1;
  }

  // Populate default team dropdown
  function renderAgentImportTeams() {
    var dd = document.getElementById("agentImportDefaultTeam");
    if (dd) dd.innerHTML = state.teams.map(function(t) { return '<option value="' + t + '">' + t + '</option>'; }).join("");
  }
  renderAgentImportTeams();

  var agentParsedRows = [];

  document.getElementById("agentPreviewBtn").addEventListener("click", function() {
    var fileInput = document.getElementById("agentFileInput");
    if (!fileInput.files || !fileInput.files[0]) { showToast("Please select a file first", "error"); return; }

    var file = fileInput.files[0];
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = new Uint8Array(e.target.result);
        var workbook = XLSX.read(data, { type: "array" });
        var sheetName = workbook.SheetNames[0];
        var sheet = workbook.Sheets[sheetName];
        var jsonRows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

        if (jsonRows.length < 2) { showToast("File needs a header row + at least 1 data row", "error"); return; }

        var headers = jsonRows[0].map(function(h) { return String(h).toLowerCase().replace(/[^a-z0-9]/g, ""); });
        console.log("Agent import headers:", headers);

        var colMap = {
          name: findColIdx(headers, ["name", "fullname", "agent", "agentname", "employee", "staff", "person", "firstname"]),
          email: findColIdx(headers, ["email", "emailaddress", "mail", "contact"]),
          team: findColIdx(headers, ["team", "department", "group", "division", "unit", "section"])
        };

        if (colMap.name < 0) {
          var rawHeaders = jsonRows[0].map(function(h) { return String(h); }).join(", ");
          showToast("Could not find a 'name' column.", "error");
          document.getElementById("agentPreviewArea").innerHTML = '<div style="color:#f87171; font-size:12px;">Headers found: <strong>' + rawHeaders + '</strong><br>Expected a column named: name, fullname, agent, employee, staff</div>';
          return;
        }

        agentParsedRows = [];
        var existingNames = state.agents.map(function(a) { return a.name.toLowerCase(); });
        var duplicates = 0;

        for (var i = 1; i < jsonRows.length; i++) {
          var cols = jsonRows[i];
          var name = String(cols[colMap.name] || "").trim();
          if (!name) continue;

          var email = colMap.email >= 0 ? String(cols[colMap.email] || "").trim() : "";
          var team = colMap.team >= 0 ? String(cols[colMap.team] || "").trim() : "";
          var isDuplicate = existingNames.indexOf(name.toLowerCase()) >= 0;
          if (isDuplicate) duplicates++;

          agentParsedRows.push({ name: name, email: email, team: team, isDuplicate: isDuplicate });
        }

        if (agentParsedRows.length === 0) { showToast("No valid agent rows found", "error"); return; }

        // Column mapping
        var mapInfo = Object.keys(colMap).map(function(k) {
          return '<span style="margin-right:10px;"><strong>' + k + ':</strong> ' + (colMap[k] >= 0 ? '"' + jsonRows[0][colMap[k]] + '"' : '<span style="color:#f87171;">not found</span>') + '</span>';
        }).join("");

        // Stats
        var teamsInFile = {};
        agentParsedRows.forEach(function(r) { if (r.team) teamsInFile[r.team] = (teamsInFile[r.team] || 0) + 1; });
        var newAgents = agentParsedRows.filter(function(r) { return !r.isDuplicate; }).length;
        var statsHtml = '<div style="margin-top:6px;">';
        statsHtml += '<div><strong>Total in file:</strong> ' + agentParsedRows.length + '</div>';
        statsHtml += '<div style="color:#22c55e;"><strong>New agents:</strong> ' + newAgents + '</div>';
        statsHtml += '<div style="color:#f59e0b;"><strong>Already exist (will skip):</strong> ' + duplicates + '</div>';
        if (Object.keys(teamsInFile).length > 0) {
          statsHtml += '<div style="margin-top:6px;"><strong>Teams in file:</strong></div>';
          Object.keys(teamsInFile).forEach(function(t) {
            var isNew = state.teams.indexOf(t) === -1;
            statsHtml += '<div>&nbsp;&nbsp;' + t + ' (' + teamsInFile[t] + ')' + (isNew ? ' <span style="color:#22c55e; font-size:10px;">NEW</span>' : '') + '</div>';
          });
        }
        statsHtml += '</div>';
        document.getElementById("agentImportStats").innerHTML = statsHtml;

        // Preview table with inline team editing
        var html = '<div style="margin-bottom:6px; font-size:11px; color:#94a3b8;">File: <strong>' + file.name + '</strong> &middot; Sheet: <strong>' + sheetName + '</strong></div>';
        html += '<div style="margin-bottom:8px; font-size:11px; color:#64748b;">Columns: ' + mapInfo + '</div>';
        html += '<table class="table" style="font-size:11px;"><thead><tr><th>#</th><th>Name</th><th>Email</th><th>Team</th><th>Status</th></tr></thead><tbody>';
        var previewCount = Math.min(agentParsedRows.length, 20);
        for (var j = 0; j < previewCount; j++) {
          var r = agentParsedRows[j];
          var statusBadge = r.isDuplicate ? '<span style="color:#f59e0b; font-size:10px;">EXISTS</span>' : '<span style="color:#22c55e; font-size:10px;">NEW</span>';
          var teamDisplay = r.team || '<span style="color:#64748b; font-style:italic;">default</span>';
          html += '<tr style="' + (r.isDuplicate ? 'opacity:0.5;' : '') + '"><td>' + (j + 1) + '</td><td>' + r.name + '</td><td>' + (r.email || '\u2014') + '</td><td>' + teamDisplay + '</td><td>' + statusBadge + '</td></tr>';
        }
        if (agentParsedRows.length > 20) html += '<tr><td colspan="5" style="text-align:center; color:#64748b;">... and ' + (agentParsedRows.length - 20) + ' more</td></tr>';
        html += '</tbody></table>';

        document.getElementById("agentPreviewArea").innerHTML = html;
        document.getElementById("agentConfirmBtn").style.display = newAgents > 0 ? "block" : "none";
        document.getElementById("agentImportResult").innerHTML = newAgents === 0 ? '<span style="color:#f59e0b;">All agents already exist. Nothing to import.</span>' : "";
      } catch (err) {
        showToast("Error reading file: " + err.message, "error");
        console.error("Agent import error:", err);
      }
    };
    reader.readAsArrayBuffer(file);
  });

  document.getElementById("agentConfirmBtn").addEventListener("click", function() {
    if (!agentParsedRows.length) { showToast("Preview first", "error"); return; }

    var defaultTeam = document.getElementById("agentImportDefaultTeam").value || "Unknown";
    var imported = 0;
    var newTeams = [];

    agentParsedRows.forEach(function(row) {
      if (row.isDuplicate) return;
      var team = row.team || defaultTeam;

      // Auto-create team if it doesn't exist
      if (state.teams.indexOf(team) === -1) {
        state.teams.push(team);
        newTeams.push(team);
      }

      state.agents.push({
        id: "AG-" + String(Date.now()).slice(-6) + "-" + String(imported),
        name: row.name,
        team: team,
        email: row.email || ""
      });
      imported++;
    });

    saveState(state);
    document.getElementById("agentFileInput").value = "";
    document.getElementById("agentPreviewArea").innerHTML = "";
    document.getElementById("agentConfirmBtn").style.display = "none";
    var msg = 'Imported ' + imported + ' agents';
    if (newTeams.length > 0) msg += ' (created ' + newTeams.length + ' new team' + (newTeams.length > 1 ? 's' : '') + ': ' + newTeams.join(', ') + ')';
    document.getElementById("agentImportResult").innerHTML = '<span style="color:#22c55e;">' + msg + '</span>';
    document.getElementById("agentImportStats").innerHTML = "Upload a file to see stats.";
    agentParsedRows = [];
    renderAll();
    showToast(msg, "success");
  });

  // --- GOOGLE PLACES API ---
  var GOOGLE_CONFIG_KEY = "axxess_google_api_config";

  function loadGoogleConfig() {
    try { return JSON.parse(localStorage.getItem(GOOGLE_CONFIG_KEY)) || {}; } catch(e) { return {}; }
  }

  // Load saved config
  var googleConfig = loadGoogleConfig();
  var googleApiKeyInput = document.getElementById("googleApiKey");
  var googlePlaceIdInput = document.getElementById("googlePlaceId");
  if (googleConfig.apiKey) googleApiKeyInput.value = googleConfig.apiKey;
  if (googleConfig.placeId) googlePlaceIdInput.value = googleConfig.placeId;

  document.getElementById("saveGoogleConfigBtn").addEventListener("click", function() {
    var apiKey = googleApiKeyInput.value.trim();
    var placeId = googlePlaceIdInput.value.trim();
    if (!apiKey) { showToast("Please enter a Google API key", "error"); return; }
    if (!placeId) { showToast("Please enter a Google Place ID", "error"); return; }
    localStorage.setItem(GOOGLE_CONFIG_KEY, JSON.stringify({ apiKey: apiKey, placeId: placeId }));
    googleConfig = { apiKey: apiKey, placeId: placeId };
    showToast("Google API config saved", "success");
    document.getElementById("googleApiResult").innerHTML = '<span style="color:#22c55e;">Config saved. Click "Fetch Reviews Now" to test.</span>';
  });

  document.getElementById("fetchGoogleReviewsBtn").addEventListener("click", function() {
    var apiKey = googleApiKeyInput.value.trim();
    var placeId = googlePlaceIdInput.value.trim();
    if (!apiKey || !placeId) { showToast("Please enter API key and Place ID first", "error"); return; }

    var resultEl = document.getElementById("googleApiResult");
    resultEl.innerHTML = '<span style="color:#64748b;">Fetching reviews from Google Places API...</span>';

    // Google Places API (New) - Place Details with reviews
    var url = "https://places.googleapis.com/v1/places/" + placeId + "?fields=displayName,rating,userRatingCount,reviews&key=" + apiKey;

    fetch(url, {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    })
    .then(function(res) {
      if (!res.ok) return res.json().then(function(err) { throw new Error(err.error ? err.error.message : "HTTP " + res.status); });
      return res.json();
    })
    .then(function(data) {
      if (!data.reviews || data.reviews.length === 0) {
        resultEl.innerHTML = '<span style="color:#f59e0b;">No reviews returned. Check your Place ID and API key permissions.</span>';
        return;
      }

      var imported = 0;
      var existingIds = state.items.map(function(i) { return i.id; });

      data.reviews.forEach(function(review) {
        var rating = review.rating || 5;
        var text = review.text ? (review.text.text || "") : "";
        var authorName = review.authorAttribution ? review.authorAttribution.displayName : "Anonymous";
        var authorPhoto = review.authorAttribution ? review.authorAttribution.photoUri : null;
        var publishTime = review.publishTime || new Date().toISOString();

        var uniqueId = "GAPI-" + authorName.replace(/[^a-z0-9]/gi, "").slice(0, 10) + "-" + publishTime.slice(0, 10).replace(/-/g, "");
        if (existingIds.indexOf(uniqueId) >= 0) return;

        var sentiment = rating >= 4 ? "Positive" : rating === 3 ? "Neutral" : "Negative";
        var status = sentiment === "Negative" ? "Flagged (Negative)" : "Pending";
        var tvSnippet = text.length > 120 ? text.substring(0, 120) + "..." : text;

        state.items.push({
          id: uniqueId,
          createdAt: publishTime,
          source: "Google",
          rating: rating,
          sentiment: sentiment,
          status: status,
          agent: "Unknown",
          team: "Unknown",
          theme: "",
          keywords: [],
          tvSnippet: tvSnippet,
          text: text,
          reviewerName: authorName,
          reviewerThumbnail: authorPhoto
        });
        imported++;
      });

      saveState(state);
      renderAll();

      var placeRating = data.rating ? data.rating.toFixed(1) : "N/A";
      var totalReviews = data.userRatingCount || "N/A";
      resultEl.innerHTML = '<span style="color:#22c55e;">Fetched ' + data.reviews.length + ' reviews (' + imported + ' new). Business rating: ' + placeRating + ' (' + totalReviews + ' total)</span>';
      if (imported > 0) showToast("Imported " + imported + " new Google reviews", "success");
      else showToast("No new reviews to import", "success");
    })
    .catch(function(err) {
      console.error("Google API error:", err);
      resultEl.innerHTML = '<span style="color:#f87171;">Error: ' + err.message + '</span>';
      if (err.message.indexOf("API key") >= 0 || err.message.indexOf("denied") >= 0) {
        resultEl.innerHTML += '<br><span style="font-size:10px; color:#64748b;">Make sure the Places API (New) is enabled and the API key is not restricted to other APIs.</span>';
      }
    });
  });

  // Export helpers
  function downloadCSV(filename, csvContent) {
    var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  function escCSV(val) {
    var s = String(val || "").replace(/"/g, '""');
    return '"' + s + '"';
  }

  // Sentiment Report Export
  document.getElementById("exportSentimentBtn").addEventListener("click", function() {
    var rows = [["Metric", "Value"]];

    var stats = computeStats(state);
    rows.push(["Total Reviews", state.items.length]);
    rows.push(["Pending", stats.pending]);
    rows.push(["Approved", state.items.filter(function(i) { return i.status === "Approved"; }).length]);
    rows.push(["Negative Flagged", stats.negativeFlagged]);
    rows.push(["Avg Sentiment", stats.avgSentiment]);
    rows.push([]);
    rows.push(["Theme", "Count", "Avg Rating"]);

    var themeMap = {};
    state.items.forEach(function(it) {
      var t = it.theme || "Uncategorized";
      if (!themeMap[t]) themeMap[t] = { count: 0, totalRating: 0, ratedCount: 0 };
      themeMap[t].count++;
      if (it.rating != null) { themeMap[t].totalRating += it.rating; themeMap[t].ratedCount++; }
    });
    Object.keys(themeMap).sort(function(a, b) { return themeMap[b].count - themeMap[a].count; }).forEach(function(t) {
      var avg = themeMap[t].ratedCount > 0 ? (themeMap[t].totalRating / themeMap[t].ratedCount).toFixed(1) : "N/A";
      rows.push([t, themeMap[t].count, avg]);
    });

    rows.push([]);
    rows.push(["Agent", "Team", "Reviews", "Score", "Avg Manager Rating"]);
    var agentMap = {};
    state.items.forEach(function(it) {
      var a = it.agent || "Unknown";
      if (!agentMap[a]) agentMap[a] = { team: it.team, count: 0, score: 0, mTotal: 0, mCount: 0 };
      agentMap[a].count++;
      agentMap[a].score += scoreItem(it);
      if (it.managerRating != null) { agentMap[a].mTotal += it.managerRating; agentMap[a].mCount++; }
    });
    Object.keys(agentMap).sort(function(a, b) { return agentMap[b].score - agentMap[a].score; }).forEach(function(a) {
      var m = agentMap[a];
      var avgMgr = m.mCount > 0 ? (m.mTotal / m.mCount).toFixed(1) : "N/A";
      rows.push([a, m.team, m.count, Math.round(m.score), avgMgr]);
    });

    var csv = rows.map(function(r) { return r.map(escCSV).join(","); }).join("\n");
    downloadCSV("axxess-sentiment-report-" + new Date().toISOString().slice(0, 10) + ".csv", csv);
    showToast("Sentiment report downloaded", "success");
  });

  // Full Data Export
  document.getElementById("exportFullBtn").addEventListener("click", function() {
    var headers = ["ID", "Date", "Source", "Rating", "Manager Rating", "Sentiment", "Status", "Agent", "Team", "Theme", "Keywords", "Reviewer", "Text"];
    var rows = [headers];

    state.items.forEach(function(it) {
      rows.push([
        it.id,
        it.createdAt,
        it.source,
        it.rating != null ? it.rating : "",
        it.managerRating != null ? it.managerRating : "",
        it.sentiment,
        it.status,
        it.agent,
        it.team,
        it.theme,
        (it.keywords || []).join("; "),
        it.reviewerName || "",
        it.text
      ]);
    });

    var csv = rows.map(function(r) { return r.map(escCSV).join(","); }).join("\n");
    downloadCSV("axxess-reviews-export-" + new Date().toISOString().slice(0, 10) + ".csv", csv);
    showToast("Full data export downloaded (" + state.items.length + " reviews)", "success");
  });

  console.log("Manager Portal ready. Items:", state.items.length);
})();
  </script>
</body>
</html>
