<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Axxess - Manager Portal</title>
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="adminShell">
    <aside class="sidebar">
      <div class="brand">
        <img class="logo" src="https://i.ibb.co/1GrhnMc4/images.jpg" alt="Axxess" />
        <div class="titleBlock">
          <div class="title">Manager Portal</div>
          <div class="subtitle">Approvals + performance insights</div>
        </div>
      </div>

      <div class="navGroup" id="nav">
        <a class="navItem active" href="#overview" data-view="overview">Overview</a>
        <a class="navItem" href="#queue" data-view="queue">Approvals Queue</a>
        <a class="navItem" href="#approved" data-view="approved">Approved Reviews</a>
        <a class="navItem" href="#agents" data-view="agents">Agents &amp; Teams</a>
        <a class="navItem" href="#negative" data-view="negative">Negative (Internal)</a>
        <a class="navItem" href="#import" data-view="import">Import / Export</a>
      </div>
    </aside>

    <main class="main">
      <div class="topbar" style="margin-bottom:14px;">
        <div>
          <div class="title" id="viewTitle">Overview</div>
          <div class="subtitle" id="viewSubtitle">High level health and pipeline</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;"><input type="color" id="brandColorPicker" style="width:32px; height:32px; border:none; background:none; cursor:pointer;" /><span class="btn" id="btnBrand">Theme</span></label>
          <button class="btn" id="resetBtn">Reset demo data</button>
          <a class="btn primary" href="./tv.html">Open TV</a>
          <a class="btn" href="./index.html">Home</a>
        </div>
      </div>

      <section id="view-overview">
        <div id="helpBanner" style="display:none; margin-bottom:14px; padding:14px 18px; border-radius:12px; border:2px solid rgba(0,153,204,.4); background:rgba(0,153,204,.08); color:var(--text);">
          <div style="font-weight:900; margin-bottom:6px;">ðŸ‘‹ Welcome to the Manager Portal</div>
          <div style="font-size:13px; line-height:1.4; color:var(--muted);">
            Click <strong style="color:var(--brand-dark);">Reset demo data</strong> (top right) to load <strong style="color:var(--brand-dark);">140 realistic feedback items</strong> across 60 days. Then approve items in the Queue to see them appear on the TV Dashboard.
          </div>
        </div>

        <div class="kpis" id="kpis"></div>

        <div class="sectionTitle">Insights</div>
        <div class="split">
          <div class="preview">
            <div class="previewLabel">Top themes</div>
            <div class="previewText" id="themes"></div>
          </div>
          <div class="preview">
            <div class="previewLabel">Team comparison</div>
            <div class="previewText" id="teams"></div>
          </div>
        </div>
      </section>

      <section id="view-queue" style="display:none;">
        <div class="sectionTitle">Approvals Queue</div>

        <div class="preview" style="margin-bottom:14px;">
          <div class="previewLabel">Filters</div>
          <div style="display:grid; grid-template-columns:1.2fr .8fr .8fr .8fr; gap:10px; margin-top:10px;">
            <input class="select" id="qSearch" placeholder="Search text, agent, theme..." />
            <select class="select" id="qSource"></select>
            <select class="select" id="qTeam"></select>
            <select class="select" id="qStatus"></select>
          </div>
        </div>

        <div class="split">
          <div>
            <table class="table" id="queueTable"></table>
          </div>
          <div class="preview">
            <div class="previewLabel">Selected item</div>
            <div class="previewText" id="previewText">Select a row to preview the full text and actions.</div>

            <div class="previewLabel" style="margin-top:14px;">Assign agent</div>
            <select class="select" id="agentSelect"></select>

            <div class="previewLabel" style="margin-top:14px;">Manager Rating (adds to agent score)</div>
            <div style="display:flex; gap:4px; margin-top:6px;" id="managerRatingStars"></div>

            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
              <button class="btn success" id="approveBtn">Approve to TV</button>
              <button class="btn" id="holdBtn">Hold</button>
              <button class="btn danger" id="flagNegBtn">Flag negative</button>
            </div>
          </div>
        </div>
      </section>

      <section id="view-approved" style="display:none;">
        <div class="sectionTitle" style="display:flex; justify-content:space-between; align-items:center;">
          <span>Approved Reviews</span>
          <div style="display:flex; gap:10px;">
            <button class="btn danger" id="resetApprovedBtn" style="font-size:12px;">Reset All to Pending</button>
          </div>
        </div>
        <div class="preview" style="margin-bottom:10px;">
          <div class="previewLabel">Approved items shown on TV Dashboard</div>
          <div class="previewText" style="font-size:12px; color:var(--muted);">These reviews are visible on the TV Dashboard. You can remove individual reviews or reset all back to Pending.</div>
        </div>
        <div id="approvedReviewsList"></div>
      </section>

      <section id="view-agents" style="display:none;">
        <div class="sectionTitle">Agents &amp; Teams</div>
        <div class="split">
          <div>
            <table class="table" id="agentsTable"></table>
          </div>
          <div class="preview">
            <div class="previewLabel">Add New Agent</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
              <input class="select" id="newAgentName" placeholder="Full name" />
              <input class="select" id="newAgentEmail" placeholder="Email" />
            </div>
            <div style="margin-top:10px;">
              <select class="select" id="newAgentTeam"></select>
            </div>
            <button class="btn success" id="addAgentBtn" style="margin-top:12px; width:100%;">+ Add Agent</button>

            <div class="previewLabel" style="margin-top:20px;">Teams</div>
            <div class="previewText" id="teamList"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <input class="select" id="newTeamName" placeholder="New team name" style="flex:1;" />
              <button class="btn" id="addTeamBtn">+ Add</button>
            </div>
          </div>
        </div>
      </section>

      <section id="view-negative" style="display:none;">
        <div class="sectionTitle">Negative Feedback (Internal only)</div>
        <div class="preview">
          <div class="previewLabel">Top negative themes</div>
          <div class="previewText" id="negativeThemes"></div>
        </div>

        <div class="sectionTitle">Negative Reviews</div>
        <div id="negativeReviewsList"></div>

        <div class="sectionTitle" style="margin-top:14px;">Notes</div>
        <div class="preview">
          <div class="previewLabel">Policy</div>
          <div class="previewText">Negative feedback is not shown on the TV dashboard. Items can be reviewed, categorized, and used for coaching and operational improvements.</div>
        </div>
      </section>
      <section id="view-import" style="display:none;">
        <div class="sectionTitle">Import Feedback</div>
        <div class="split">
          <div class="preview">
            <div class="previewLabel">Mass Import Email Feedback</div>
            <div class="previewText" style="font-size:12px; color:var(--muted); margin-bottom:10px;">Paste email feedback below (one per line). Format: <strong>reviewer name | rating (1-5) | feedback text</strong></div>
            <textarea id="emailImportText" class="select" rows="8" style="width:100%; resize:vertical; font-size:12px;" placeholder="John Smith | 5 | Great service from the support team!&#10;Jane Doe | 4 | Fast installation, very happy&#10;Bob Wilson | 2 | Waited too long for a response"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <select class="select" id="importTeam" style="flex:1;"></select>
              <button class="btn success" id="importEmailBtn" style="flex:0 0 auto;">Import Feedback</button>
            </div>
            <div id="importResult" style="margin-top:10px; font-size:12px;"></div>
          </div>
          <div class="preview">
            <div class="previewLabel">Import from Excel / CSV</div>
            <div class="previewText" style="font-size:12px; color:var(--muted); margin-bottom:10px;">Upload an <strong>.xlsx, .xls, or .csv</strong> file. Columns are auto-detected from the header row. Expected: <strong>name, rating, text</strong> (team, agent optional).</div>
            <input type="file" id="fileImportInput" accept=".xlsx,.xls,.csv" class="select" style="padding:8px;" />
            <button class="btn" id="filePreviewBtn" style="margin-top:10px; width:100%;">Preview File</button>
            <div id="filePreviewArea" style="margin-top:10px; max-height:300px; overflow:auto; font-size:12px;"></div>
            <button class="btn success" id="fileConfirmBtn" style="margin-top:10px; width:100%; display:none;">Confirm Import</button>
            <div id="fileResult" style="margin-top:10px; font-size:12px;"></div>
          </div>
        </div>

        <div class="sectionTitle" style="margin-top:20px;">Export Reports</div>
        <div class="split">
          <div class="preview">
            <div class="previewLabel">Sentiment Report</div>
            <div class="previewText" style="font-size:12px; color:var(--muted);">Export a summary of sentiment analysis, themes, and agent performance.</div>
            <button class="btn" id="exportSentimentBtn" style="margin-top:10px; width:100%;">Download Sentiment Report (CSV)</button>
          </div>
          <div class="preview">
            <div class="previewLabel">Full Data Export</div>
            <div class="previewText" style="font-size:12px; color:var(--muted);">Export all reviews with full details for external analysis.</div>
            <button class="btn" id="exportFullBtn" style="margin-top:10px; width:100%;">Download All Reviews (CSV)</button>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script src="./app.js"></script>
  <script>
(function() {
  var root = document.documentElement;
  var state = loadState();
  root.style.setProperty("--brand", state.brand.primary);

  var views = ["overview", "queue", "approved", "agents", "negative", "import"];
  var viewTitle = document.getElementById("viewTitle");
  var viewSubtitle = document.getElementById("viewSubtitle");

  var sections = {
    overview: document.getElementById("view-overview"),
    queue: document.getElementById("view-queue"),
    approved: document.getElementById("view-approved"),
    agents: document.getElementById("view-agents"),
    negative: document.getElementById("view-negative"),
    import: document.getElementById("view-import")
  };

  var subtitles = {
    overview: "High level health and pipeline",
    queue: "Review items before they appear on the TV dashboard",
    approved: "Manage approved reviews shown on the TV dashboard",
    agents: "Manage agent directory and team mapping",
    negative: "Internal-only negative feedback themes",
    import: "Import email feedback and export reports"
  };

  function setActive(view) {
    views.forEach(function(v) {
      if (sections[v]) sections[v].style.display = v === view ? "block" : "none";
    });
    document.querySelectorAll("#nav .navItem").forEach(function(a) {
      a.classList.toggle("active", a.getAttribute("data-view") === view);
    });
    var titles = { overview: "Overview", queue: "Approvals Queue", approved: "Approved Reviews", agents: "Agents & Teams", negative: "Negative (Internal)", import: "Import / Export" };
    viewTitle.textContent = titles[view] || view;
    viewSubtitle.textContent = subtitles[view] || "";
  }

  function parseHash() {
    var raw = (location.hash || "#overview").replace("#", "");
    return views.indexOf(raw) !== -1 ? raw : "overview";
  }

  window.addEventListener("hashchange", function() { setActive(parseHash()); });
  setActive(parseHash());

  var kpis = document.getElementById("kpis");
  var themes = document.getElementById("themes");
  var teams = document.getElementById("teams");
  var selectedId = null;

  var queueTable = document.getElementById("queueTable");
  var previewText = document.getElementById("previewText");
  var agentSelect = document.getElementById("agentSelect");
  var qSearch = document.getElementById("qSearch");
  var qSource = document.getElementById("qSource");
  var qTeam = document.getElementById("qTeam");
  var qStatus = document.getElementById("qStatus");

  function renderAgentSelect(current) {
    var options = ["Unknown"].concat(state.agents.map(function(a) { return a.name; }));
    agentSelect.innerHTML = options.map(function(n) { return '<option value="' + n + '">' + n + '</option>'; }).join("");
    agentSelect.value = current || "Unknown";
  }

  function rowBadge(text) {
    return '<span class="pill">' + String(text || "") + '</span>';
  }

  function populateFilters() {
    if (qSource) {
      var sources = ["All"].concat(Array.from(new Set(state.items.map(function(i) { return i.source; }))).sort());
      qSource.innerHTML = sources.map(function(s) { return '<option value="' + s + '">' + s + '</option>'; }).join("");
    }
    if (qTeam) {
      var teamsList = ["All"].concat(state.teams);
      qTeam.innerHTML = teamsList.map(function(t) { return '<option value="' + t + '">' + t + '</option>'; }).join("");
    }
    if (qStatus) {
      var statuses = ["All", "Pending", "On hold", "Approved", "Flagged (Negative)"];
      qStatus.innerHTML = statuses.map(function(s) { return '<option value="' + s + '">' + s + '</option>'; }).join("");
    }
  }

  function getFilteredQueue() {
    var search = (qSearch && qSearch.value || "").trim().toLowerCase();
    var source = qSource && qSource.value || "All";
    var team = qTeam && qTeam.value || "All";
    var status = qStatus && qStatus.value || "All";

    return state.items
      .filter(function(i) { return i.status !== "Approved" || i.sentiment === "Negative"; })
      .filter(function(i) { return source === "All" || i.source === source; })
      .filter(function(i) { return team === "All" || i.team === team; })
      .filter(function(i) { return status === "All" || i.status === status; })
      .filter(function(i) {
        if (!search) return true;
        var blob = (i.id + " " + i.source + " " + i.sentiment + " " + i.status + " " + i.agent + " " + i.team + " " + i.theme + " " + i.text).toLowerCase();
        return blob.indexOf(search) !== -1;
      })
      .sort(function(a, b) { return new Date(b.createdAt) - new Date(a.createdAt); });
  }

  function renderQueue() {
    var items = getFilteredQueue();
    if (!selectedId && items[0]) selectedId = items[0].id;

    queueTable.innerHTML = '<thead><tr><th>Date</th><th>Source</th><th>Rating</th><th>Sentiment</th><th>Agent</th><th>Team</th><th>Status</th></tr></thead><tbody>' +
      items.map(function(q) {
        var rating = q.rating == null ? "â€”" : q.rating + "/5";
        var isSelected = q.id === selectedId;
        var d = new Date(q.createdAt);
        var dateLabel = isNaN(d.getTime()) ? q.createdAt : d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
        return '<tr data-id="' + q.id + '" style="cursor:pointer; background:' + (isSelected ? "rgba(11,126,168,.15)" : "transparent") + '"><td>' + dateLabel + '</td><td>' + rowBadge(q.source) + '</td><td>' + rating + '</td><td>' + rowBadge(q.sentiment) + '</td><td>' + q.agent + '</td><td>' + q.team + '</td><td>' + rowBadge(q.status) + '</td></tr>';
      }).join("") + '</tbody>';

    queueTable.querySelectorAll("tbody tr").forEach(function(tr) {
      tr.addEventListener("click", function() {
        selectedId = tr.getAttribute("data-id");
        renderQueue();
        renderPreview();
      });
    });
  }

  var managerRatingStars = document.getElementById("managerRatingStars");

  function renderManagerRating(currentRating) {
    var html = "";
    for (var i = 1; i <= 5; i++) {
      var color = i <= (currentRating || 0) ? "#fbbf24" : "#4b5563";
      html += '<span data-star="' + i + '" style="cursor:pointer; font-size:24px; color:' + color + '; transition:color 0.15s;">â˜…</span>';
    }
    html += currentRating ? ' <span style="font-size:12px; color:var(--muted); margin-left:6px;">' + currentRating + '/5</span>' : ' <span style="font-size:12px; color:var(--muted); margin-left:6px;">Not rated</span>';
    managerRatingStars.innerHTML = html;

    managerRatingStars.querySelectorAll("[data-star]").forEach(function(star) {
      star.addEventListener("click", function() {
        var item = state.items.find(function(q) { return q.id === selectedId; });
        if (!item) { showToast("Select an item first", "error"); return; }
        var val = parseInt(star.getAttribute("data-star"));
        state = updateItem(item.id, { managerRating: val });
        renderManagerRating(val);
        showToast("Manager rating: " + val + "/5 (+" + (val * 6) + " score points)", "success");
      });
    });
  }

  function renderPreview() {
    var item = state.items.find(function(q) { return q.id === selectedId; });
    if (!item) {
      previewText.textContent = "Select a row to preview the full text and actions.";
      renderAgentSelect("Unknown");
      renderManagerRating(null);
      return;
    }
    previewText.textContent = item.text;
    renderAgentSelect(item.agent);
    renderManagerRating(item.managerRating);
  }

  function updateSelectedStatus(status) {
    var item = state.items.find(function(q) { return q.id === selectedId; });
    if (!item) {
      showToast("Please select an item first", "error");
      return;
    }
    var patch = { status: status };
    if (status === "Flagged (Negative)") patch.sentiment = "Negative";
    state = updateItem(item.id, patch);
    renderAll();
    showToast("Item " + item.id + " â†’ " + status, "success");
  }

  document.getElementById("approveBtn").addEventListener("click", function() { updateSelectedStatus("Approved"); });
  document.getElementById("holdBtn").addEventListener("click", function() { updateSelectedStatus("On hold"); });
  document.getElementById("flagNegBtn").addEventListener("click", function() { updateSelectedStatus("Flagged (Negative)"); });

  agentSelect.addEventListener("change", function() {
    var item = state.items.find(function(q) { return q.id === selectedId; });
    if (!item) return;
    var nextAgent = agentSelect.value;
    var agent = state.agents.find(function(a) { return a.name === nextAgent; });
    state = updateItem(item.id, { agent: nextAgent, team: agent ? agent.team : "Unknown" });
    renderAll();
    showToast("Assigned to " + nextAgent, "success");
  });

  if (qSearch) qSearch.addEventListener("input", function() { renderAll(); });
  if (qSource) qSource.addEventListener("change", function() { renderAll(); });
  if (qTeam) qTeam.addEventListener("change", function() { renderAll(); });
  if (qStatus) qStatus.addEventListener("change", function() { renderAll(); });

  // --- AGENTS & TEAMS CRUD ---
  var agentsTable = document.getElementById("agentsTable");
  var teamList = document.getElementById("teamList");
  var newAgentTeam = document.getElementById("newAgentTeam");

  function renderAgents() {
    agentsTable.innerHTML = '<thead><tr><th>Name</th><th>Team</th><th>Email</th><th style="width:80px;">Action</th></tr></thead><tbody>' +
      state.agents.map(function(a) {
        return '<tr><td>' + a.name + '</td><td>' + rowBadge(a.team) + '</td><td>' + a.email + '</td><td><button class="btn danger" data-delete-agent="' + a.id + '" style="padding:4px 10px; font-size:11px;">Remove</button></td></tr>';
      }).join("") + '</tbody>';

    teamList.innerHTML = state.teams.map(function(t) { return '<span class="themeChip">' + t + '</span>'; }).join(" ");

    // Populate team dropdown for new agent form
    if (newAgentTeam) {
      newAgentTeam.innerHTML = state.teams.map(function(t) { return '<option value="' + t + '">' + t + '</option>'; }).join("");
    }

    // Bind delete buttons
    agentsTable.querySelectorAll("[data-delete-agent]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var agentId = btn.getAttribute("data-delete-agent");
        var agent = state.agents.find(function(a) { return a.id === agentId; });
        if (!agent) return;
        if (!confirm("Remove agent " + agent.name + "?")) return;
        state.agents = state.agents.filter(function(a) { return a.id !== agentId; });
        saveState(state);
        renderAll();
        showToast("Removed " + agent.name, "success");
      });
    });
  }

  // Add Agent button
  document.getElementById("addAgentBtn").addEventListener("click", function() {
    var nameEl = document.getElementById("newAgentName");
    var emailEl = document.getElementById("newAgentEmail");
    var teamEl = document.getElementById("newAgentTeam");
    var name = (nameEl.value || "").trim();
    var email = (emailEl.value || "").trim();
    var team = teamEl.value;

    if (!name) { showToast("Please enter agent name", "error"); return; }
    if (!email) { showToast("Please enter agent email", "error"); return; }
    if (!team) { showToast("Please select a team", "error"); return; }

    var id = "AG-" + String(Date.now()).slice(-6);
    state.agents.push({ id: id, name: name, team: team, email: email });
    saveState(state);
    nameEl.value = "";
    emailEl.value = "";
    renderAll();
    showToast("Added agent " + name, "success");
  });

  // Add Team button
  document.getElementById("addTeamBtn").addEventListener("click", function() {
    var teamInput = document.getElementById("newTeamName");
    var teamName = (teamInput.value || "").trim();
    if (!teamName) { showToast("Please enter a team name", "error"); return; }
    if (state.teams.indexOf(teamName) !== -1) { showToast("Team already exists", "error"); return; }
    state.teams.push(teamName);
    saveState(state);
    teamInput.value = "";
    renderAll();
    showToast("Added team " + teamName, "success");
  });

  // --- APPROVED REVIEWS MANAGEMENT ---
  var approvedReviewsList = document.getElementById("approvedReviewsList");

  function renderApproved() {
    var approved = state.items.filter(function(i) { return i.status === "Approved" && i.sentiment !== "Negative"; });
    approved.sort(function(a, b) { return new Date(b.createdAt) - new Date(a.createdAt); });

    approvedReviewsList.innerHTML = approved.length ? approved.map(function(item) {
      var d = new Date(item.createdAt);
      var dateLabel = isNaN(d.getTime()) ? item.createdAt : d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
      var ratingStr = item.rating != null ? item.rating + "/5" : "â€”";
      var reviewer = item.reviewerName || item.agent || "Unknown";
      var textPreview = item.text.length > 200 ? item.text.substring(0, 200) + "..." : item.text;
      return '<div class="preview" style="margin-bottom:10px;">' +
        '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">' +
          '<div><strong>' + reviewer + '</strong> Â· ' + rowBadge(item.source) + ' Â· ' + rowBadge(ratingStr) + ' Â· ' + rowBadge(item.theme || "General") + '</div>' +
          '<div style="display:flex; gap:8px; align-items:center;">' +
            '<span style="color:var(--muted); font-size:12px;">' + dateLabel + '</span>' +
            '<button class="btn danger" data-unapprove="' + item.id + '" style="padding:4px 10px; font-size:11px;">Remove from TV</button>' +
            '<button class="btn" data-delete-review="' + item.id + '" style="padding:4px 10px; font-size:11px;">Delete</button>' +
          '</div>' +
        '</div>' +
        '<div class="previewText" style="font-size:13px; line-height:1.5;">' + textPreview + '</div>' +
      '</div>';
    }).join("") : '<div class="preview"><div class="previewText" style="color:var(--muted);">No approved reviews yet. Approve items from the Queue to see them here and on the TV Dashboard.</div></div>';

    // Bind unapprove buttons (set back to Pending)
    approvedReviewsList.querySelectorAll("[data-unapprove]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var id = btn.getAttribute("data-unapprove");
        state = updateItem(id, { status: "Pending" });
        renderAll();
        showToast("Moved back to Pending", "success");
      });
    });

    // Bind delete buttons (permanently remove)
    approvedReviewsList.querySelectorAll("[data-delete-review]").forEach(function(btn) {
      btn.addEventListener("click", function() {
        var id = btn.getAttribute("data-delete-review");
        var item = state.items.find(function(i) { return i.id === id; });
        if (!item) return;
        if (!confirm("Permanently delete this review?")) return;
        state.items = state.items.filter(function(i) { return i.id !== id; });
        saveState(state);
        renderAll();
        showToast("Review deleted", "success");
      });
    });
  }

  // Reset All Approved to Pending
  document.getElementById("resetApprovedBtn").addEventListener("click", function() {
    var approved = state.items.filter(function(i) { return i.status === "Approved" && i.sentiment !== "Negative"; });
    if (approved.length === 0) { showToast("No approved reviews to reset", "error"); return; }
    if (!confirm("Reset all " + approved.length + " approved reviews back to Pending?")) return;
    approved.forEach(function(item) {
      state = updateItem(item.id, { status: "Pending" });
    });
    renderAll();
    showToast(approved.length + " reviews reset to Pending", "success");
  });

  // --- NEGATIVE TAB ---
  var negativeThemes = document.getElementById("negativeThemes");
  var negativeReviewsList = document.getElementById("negativeReviewsList");

  function renderNegative() {
    var neg = state.items.filter(function(i) { return i.sentiment === "Negative" || i.status === "Flagged (Negative)"; });

    // Theme summary
    var map = {};
    neg.forEach(function(it) {
      var key = it.theme || "Uncategorized";
      map[key] = (map[key] || 0) + 1;
    });
    var rows = Object.keys(map).map(function(k) { return [k, map[k]]; }).sort(function(a, b) { return b[1] - a[1]; });
    negativeThemes.innerHTML = rows.length ? rows.map(function(r) {
      return '<div style="display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06);"><span>' + r[0] + '</span><span style="color:var(--muted); font-weight:900;">' + r[1] + '</span></div>';
    }).join("") : '<div style="color:var(--muted);">No negative themes found.</div>';

    // Individual negative reviews
    neg.sort(function(a, b) { return new Date(b.createdAt) - new Date(a.createdAt); });
    negativeReviewsList.innerHTML = neg.length ? neg.map(function(item) {
      var d = new Date(item.createdAt);
      var dateLabel = isNaN(d.getTime()) ? item.createdAt : d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
      var ratingStr = item.rating != null ? item.rating + "/5" : "â€”";
      var reviewer = item.reviewerName || item.agent || "Unknown";
      var textPreview = item.text.length > 300 ? item.text.substring(0, 300) + "..." : item.text;
      return '<div class="preview" style="margin-bottom:10px;">' +
        '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">' +
          '<div><strong>' + reviewer + '</strong> Â· ' + rowBadge(item.source) + ' Â· ' + rowBadge(ratingStr) + ' Â· ' + rowBadge(item.theme || "Uncategorized") + '</div>' +
          '<div style="color:var(--muted); font-size:12px;">' + dateLabel + '</div>' +
        '</div>' +
        '<div class="previewText" style="font-size:13px; line-height:1.5;">' + textPreview + '</div>' +
        '<div style="margin-top:8px; display:flex; gap:6px;">' +
          (item.keywords || []).map(function(k) { return '<span class="themeChip">' + k + '</span>'; }).join("") +
        '</div>' +
      '</div>';
    }).join("") : '<div class="preview"><div class="previewText" style="color:var(--muted);">No negative reviews found. Reviews with negative sentiment or flagged status will appear here.</div></div>';
  }

  // --- OVERVIEW ---
  function renderOverview() {
    var stats = computeStats(state);
    var kpiMap = [
      { label: "Total reviews", value: state.items.length },
      { label: "Pending approvals", value: stats.pending },
      { label: "Avg sentiment", value: stats.avgSentiment },
      { label: "Negative flagged", value: stats.negativeFlagged }
    ];
    kpis.innerHTML = kpiMap.map(function(k) {
      return '<div class="kpi"><div class="kpiLabel">' + k.label + '</div><div class="kpiValue">' + k.value + '</div></div>';
    }).join("");

    var lb = computeLeaderboards(state, new Date());
    var topThemes = [];
    lb.weeklyTop.forEach(function(a) { (a.themes || []).forEach(function(t) { if (topThemes.indexOf(t) === -1) topThemes.push(t); }); });
    themes.textContent = topThemes.length ? topThemes.slice(0, 6).join(", ") : "No themes yet â€” approve items to see themes";

    var byTeam = {};
    state.items.filter(function(i) { return i.status === "Approved" && i.sentiment !== "Negative"; }).forEach(function(it) {
      byTeam[it.team] = (byTeam[it.team] || 0) + 1;
    });
    var teamPairs = Object.keys(byTeam).map(function(t) { return [t, byTeam[t]]; }).sort(function(a, b) { return b[1] - a[1]; });
    teams.textContent = teamPairs.map(function(p) { return p[0] + ": " + p[1]; }).join(" Â· ") || "No approved items yet";
  }

  // --- RENDER ALL ---
  function renderAll() {
    state = loadState();
    root.style.setProperty("--brand", state.brand.primary);
    populateFilters();
    renderOverview();
    renderQueue();
    renderPreview();
    renderAgents();
    renderApproved();
    renderNegative();

    var helpBanner = document.getElementById("helpBanner");
    if (helpBanner) helpBanner.style.display = state.items.length === 0 ? "block" : "none";
  }

  renderAll();

  // --- THEME COLOR PICKER ---
  var brandColorPicker = document.getElementById("brandColorPicker");
  brandColorPicker.value = state.brand.primary || "#0099cc";

  document.getElementById("btnBrand").addEventListener("click", function() {
    brandColorPicker.click();
  });

  brandColorPicker.addEventListener("input", function() {
    var color = brandColorPicker.value;
    state = updateBrandPrimary(color);
    root.style.setProperty("--brand", color);
    renderAll();
  });

  brandColorPicker.addEventListener("change", function() {
    showToast("Brand color updated to " + brandColorPicker.value, "success");
  });

  // --- RESET ---
  var resetBtn = document.getElementById("resetBtn");
  if (resetBtn) {
    resetBtn.addEventListener("click", function() {
      if (!confirm("Reset all data? This will clear all reviews, agents, and settings.")) return;
      localStorage.removeItem(GOOGLE_REVIEWS_LOADED_KEY);
      state = resetState();
      root.style.setProperty("--brand", state.brand.primary);
      renderAll();
      showToast("Data reset. Refresh page to reload Google reviews.", "success");
    });
  }

  // --- IMPORT / EXPORT ---

  // Populate import team dropdown
  function renderImportTeam() {
    var importTeam = document.getElementById("importTeam");
    if (importTeam) {
      importTeam.innerHTML = state.teams.map(function(t) { return '<option value="' + t + '">' + t + '</option>'; }).join("");
    }
  }
  renderImportTeam();

  // Email Import
  document.getElementById("importEmailBtn").addEventListener("click", function() {
    var text = document.getElementById("emailImportText").value.trim();
    var team = document.getElementById("importTeam").value;
    if (!text) { showToast("Please paste feedback text", "error"); return; }

    var lines = text.split("\n").filter(function(l) { return l.trim(); });
    var imported = 0;

    lines.forEach(function(line) {
      var parts = line.split("|").map(function(p) { return p.trim(); });
      var name = parts[0] || "Anonymous";
      var rating = parts.length > 1 ? parseInt(parts[1]) : null;
      if (rating && (rating < 1 || rating > 5)) rating = null;
      var feedbackText = parts.length > 2 ? parts[2] : parts[0];

      var sentiment = rating >= 4 ? "Positive" : rating === 3 ? "Neutral" : rating <= 2 ? "Negative" : "Neutral";
      var status = sentiment === "Negative" ? "Flagged (Negative)" : "Pending";

      var id = "EM-" + String(Date.now()).slice(-6) + "-" + String(imported);
      state.items.push({
        id: id,
        createdAt: new Date().toISOString(),
        source: "Email",
        rating: rating,
        sentiment: sentiment,
        status: status,
        agent: "Unknown",
        team: team,
        theme: "",
        keywords: [],
        tvSnippet: feedbackText.length > 120 ? feedbackText.substring(0, 120) + "..." : feedbackText,
        text: feedbackText,
        reviewerName: name
      });
      imported++;
    });

    saveState(state);
    document.getElementById("emailImportText").value = "";
    document.getElementById("importResult").innerHTML = '<span style="color:#22c55e;">Imported ' + imported + ' feedback items as "' + team + '"</span>';
    renderAll();
    showToast("Imported " + imported + " email feedback items", "success");
  });

  // Excel / CSV Import with Preview (uses SheetJS)
  function findColIdx(headers, names) {
    for (var n = 0; n < names.length; n++) {
      var idx = headers.indexOf(names[n]);
      if (idx >= 0) return idx;
    }
    for (var n = 0; n < names.length; n++) {
      for (var h = 0; h < headers.length; h++) {
        if (headers[h].indexOf(names[n]) >= 0) return h;
      }
    }
    return -1;
  }

  var fileParsedRows = [];
  var fileColMap = {};

  document.getElementById("filePreviewBtn").addEventListener("click", function() {
    var fileInput = document.getElementById("fileImportInput");
    if (!fileInput.files || !fileInput.files[0]) { showToast("Please select a file first", "error"); return; }

    var file = fileInput.files[0];
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = new Uint8Array(e.target.result);
        var workbook = XLSX.read(data, { type: "array" });
        var sheetName = workbook.SheetNames[0];
        var sheet = workbook.Sheets[sheetName];
        var jsonRows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

        if (jsonRows.length < 2) { showToast("File needs a header row + at least 1 data row", "error"); return; }

        var headers = jsonRows[0].map(function(h) { return String(h).toLowerCase().replace(/[^a-z0-9]/g, ""); });
        console.log("Sheet: " + sheetName + ", Headers:", headers);

        fileColMap = {
          name: findColIdx(headers, ["name", "reviewer", "customer", "from", "person", "client", "author"]),
          rating: findColIdx(headers, ["rating", "score", "stars", "rate"]),
          text: findColIdx(headers, ["text", "feedback", "comment", "review", "message", "body", "description", "note", "content"]),
          team: findColIdx(headers, ["team", "department", "group", "division"]),
          agent: findColIdx(headers, ["agent", "assignee", "rep", "representative", "employee", "staff"])
        };

        if (fileColMap.text < 0 && fileColMap.name < 0) {
          var rawHeaders = jsonRows[0].map(function(h) { return String(h); }).join(", ");
          showToast("Could not auto-detect columns. Found headers: " + rawHeaders, "error");
          document.getElementById("filePreviewArea").innerHTML = '<div style="color:#f87171; font-size:12px;">Headers found: <strong>' + rawHeaders + '</strong><br>Expected at least one of: name, reviewer, customer, text, feedback, comment, review</div>';
          return;
        }

        fileParsedRows = [];
        for (var i = 1; i < jsonRows.length; i++) {
          var cols = jsonRows[i];
          var allEmpty = cols.every(function(c) { return String(c).trim() === ""; });
          if (allEmpty) continue;

          var name = fileColMap.name >= 0 ? String(cols[fileColMap.name] || "Anonymous") : "Anonymous";
          var rating = fileColMap.rating >= 0 ? parseInt(cols[fileColMap.rating]) : null;
          if (rating !== null && (isNaN(rating) || rating < 1 || rating > 5)) rating = null;
          var text = fileColMap.text >= 0 ? String(cols[fileColMap.text] || "") : String(cols[0] || "");
          var team = fileColMap.team >= 0 ? String(cols[fileColMap.team] || "Unknown") : "Unknown";
          var agent = fileColMap.agent >= 0 ? String(cols[fileColMap.agent] || "Unknown") : "Unknown";

          fileParsedRows.push({ name: name, rating: rating, text: text, team: team, agent: agent });
        }

        if (fileParsedRows.length === 0) { showToast("No valid data rows found", "error"); return; }

        // Column mapping info
        var mapInfo = Object.keys(fileColMap).map(function(k) {
          return '<span style="margin-right:10px;"><strong>' + k + ':</strong> ' + (fileColMap[k] >= 0 ? '"' + jsonRows[0][fileColMap[k]] + '" (col ' + (fileColMap[k] + 1) + ')' : '<span style="color:#f87171;">not found</span>') + '</span>';
        }).join("");

        // Sheet info
        var html = '<div style="margin-bottom:6px; font-size:11px; color:#94a3b8;">File: <strong>' + file.name + '</strong> &middot; Sheet: <strong>' + sheetName + '</strong> &middot; ' + workbook.SheetNames.length + ' sheet(s)</div>';
        html += '<div style="margin-bottom:8px; font-size:11px; color:#64748b;">Column mapping: ' + mapInfo + '</div>';
        html += '<div style="font-size:12px; font-weight:600; margin-bottom:6px; color:#22c55e;">' + fileParsedRows.length + ' rows ready to import</div>';
        html += '<table class="table" style="font-size:11px;"><thead><tr><th>#</th><th>Name</th><th>Rating</th><th>Text</th><th>Team</th><th>Agent</th></tr></thead><tbody>';
        var previewCount = Math.min(fileParsedRows.length, 15);
        for (var j = 0; j < previewCount; j++) {
          var r = fileParsedRows[j];
          var shortText = r.text.length > 80 ? r.text.substring(0, 80) + "..." : r.text;
          html += '<tr><td>' + (j + 1) + '</td><td>' + r.name + '</td><td>' + (r.rating || "\u2014") + '</td><td>' + shortText + '</td><td>' + r.team + '</td><td>' + r.agent + '</td></tr>';
        }
        if (fileParsedRows.length > 15) html += '<tr><td colspan="6" style="text-align:center; color:#64748b;">... and ' + (fileParsedRows.length - 15) + ' more rows</td></tr>';
        html += '</tbody></table>';

        document.getElementById("filePreviewArea").innerHTML = html;
        document.getElementById("fileConfirmBtn").style.display = "block";
        document.getElementById("fileResult").innerHTML = "";
      } catch (err) {
        showToast("Error reading file: " + err.message, "error");
        console.error("File import error:", err);
      }
    };
    reader.readAsArrayBuffer(file);
  });

  document.getElementById("fileConfirmBtn").addEventListener("click", function() {
    if (!fileParsedRows.length) { showToast("No data to import. Preview first.", "error"); return; }

    var imported = 0;
    var ts = Date.now();
    fileParsedRows.forEach(function(row) {
      var sentiment = row.rating >= 4 ? "Positive" : row.rating === 3 ? "Neutral" : (row.rating != null && row.rating <= 2) ? "Negative" : "Neutral";
      var status = sentiment === "Negative" ? "Flagged (Negative)" : "Pending";
      state.items.push({
        id: "IMP-" + String(ts).slice(-6) + "-" + String(imported),
        createdAt: new Date().toISOString(),
        source: "Email",
        rating: row.rating,
        sentiment: sentiment,
        status: status,
        agent: row.agent,
        team: row.team,
        theme: "",
        keywords: [],
        tvSnippet: row.text.length > 120 ? row.text.substring(0, 120) + "..." : row.text,
        text: row.text,
        reviewerName: row.name
      });
      imported++;
    });

    saveState(state);
    document.getElementById("fileImportInput").value = "";
    document.getElementById("filePreviewArea").innerHTML = "";
    document.getElementById("fileConfirmBtn").style.display = "none";
    document.getElementById("fileResult").innerHTML = '<span style="color:#22c55e;">Successfully imported ' + imported + ' rows</span>';
    fileParsedRows = [];
    renderAll();
    showToast("Imported " + imported + " items", "success");
  });

  // Export helpers
  function downloadCSV(filename, csvContent) {
    var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  function escCSV(val) {
    var s = String(val || "").replace(/"/g, '""');
    return '"' + s + '"';
  }

  // Sentiment Report Export
  document.getElementById("exportSentimentBtn").addEventListener("click", function() {
    var rows = [["Metric", "Value"]];

    var stats = computeStats(state);
    rows.push(["Total Reviews", state.items.length]);
    rows.push(["Pending", stats.pending]);
    rows.push(["Approved", state.items.filter(function(i) { return i.status === "Approved"; }).length]);
    rows.push(["Negative Flagged", stats.negativeFlagged]);
    rows.push(["Avg Sentiment", stats.avgSentiment]);
    rows.push([]);
    rows.push(["Theme", "Count", "Avg Rating"]);

    var themeMap = {};
    state.items.forEach(function(it) {
      var t = it.theme || "Uncategorized";
      if (!themeMap[t]) themeMap[t] = { count: 0, totalRating: 0, ratedCount: 0 };
      themeMap[t].count++;
      if (it.rating != null) { themeMap[t].totalRating += it.rating; themeMap[t].ratedCount++; }
    });
    Object.keys(themeMap).sort(function(a, b) { return themeMap[b].count - themeMap[a].count; }).forEach(function(t) {
      var avg = themeMap[t].ratedCount > 0 ? (themeMap[t].totalRating / themeMap[t].ratedCount).toFixed(1) : "N/A";
      rows.push([t, themeMap[t].count, avg]);
    });

    rows.push([]);
    rows.push(["Agent", "Team", "Reviews", "Score", "Avg Manager Rating"]);
    var agentMap = {};
    state.items.forEach(function(it) {
      var a = it.agent || "Unknown";
      if (!agentMap[a]) agentMap[a] = { team: it.team, count: 0, score: 0, mTotal: 0, mCount: 0 };
      agentMap[a].count++;
      agentMap[a].score += scoreItem(it);
      if (it.managerRating != null) { agentMap[a].mTotal += it.managerRating; agentMap[a].mCount++; }
    });
    Object.keys(agentMap).sort(function(a, b) { return agentMap[b].score - agentMap[a].score; }).forEach(function(a) {
      var m = agentMap[a];
      var avgMgr = m.mCount > 0 ? (m.mTotal / m.mCount).toFixed(1) : "N/A";
      rows.push([a, m.team, m.count, Math.round(m.score), avgMgr]);
    });

    var csv = rows.map(function(r) { return r.map(escCSV).join(","); }).join("\n");
    downloadCSV("axxess-sentiment-report-" + new Date().toISOString().slice(0, 10) + ".csv", csv);
    showToast("Sentiment report downloaded", "success");
  });

  // Full Data Export
  document.getElementById("exportFullBtn").addEventListener("click", function() {
    var headers = ["ID", "Date", "Source", "Rating", "Manager Rating", "Sentiment", "Status", "Agent", "Team", "Theme", "Keywords", "Reviewer", "Text"];
    var rows = [headers];

    state.items.forEach(function(it) {
      rows.push([
        it.id,
        it.createdAt,
        it.source,
        it.rating != null ? it.rating : "",
        it.managerRating != null ? it.managerRating : "",
        it.sentiment,
        it.status,
        it.agent,
        it.team,
        it.theme,
        (it.keywords || []).join("; "),
        it.reviewerName || "",
        it.text
      ]);
    });

    var csv = rows.map(function(r) { return r.map(escCSV).join(","); }).join("\n");
    downloadCSV("axxess-reviews-export-" + new Date().toISOString().slice(0, 10) + ".csv", csv);
    showToast("Full data export downloaded (" + state.items.length + " reviews)", "success");
  });

  console.log("Manager Portal ready. Items:", state.items.length);
})();
  </script>
</body>
</html>
